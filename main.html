<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãŸã¹ãã‚ƒã‚‰ | ãƒ¡ã‚¤ãƒ³</title>
  <link href="https://fonts.googleapis.com/css2?family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">
  <style>
    :root{ --top-gap: clamp(16px, 6vh, 56px); --overlap: 10px; }

    html,body{
      height:100%; margin:0;
      font-family:"Hachi Maru Pop",cursive;
      background:var(--bg);
    }

    /* 1ç”»é¢å›ºå®šãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã— */
    .phone,.screen{
      height:100svh; display:flex; flex-direction:column;
      overflow:hidden;
    }

    main{
      flex:1; display:flex; flex-direction:column; align-items:center;
      justify-content:flex-start;
      padding:8px 16px calc(var(--tabbar-h) + env(safe-area-inset-bottom));
      box-sizing:border-box;
      overflow:hidden;
    }

    .hero{ display:grid; place-items:center; text-align:center; gap:6px; padding:16px 16px 4px; margin-top:44px; }
    .app-title{
      font-size:clamp(22px,5.2vw,30px); font-weight:900; letter-spacing:.08em;
      -webkit-text-stroke:1px rgba(0,0,0,.06); line-height:1.05;
    }
    .lead{ color:var(--sub); font-size:13px; }

    .main-wrap{ display:grid; gap:12px; padding:20px 16px 0; }

    .card{ background:none; border:none; box-shadow:none; border-radius:0; display:grid; gap:10px; margin-top:6px; }

    /* ===== ãƒšãƒƒãƒˆï¼†ãƒœã‚¿ãƒ³é‡ã­ ===== */
    .pet-stage{
      position:relative;
      display:grid;
      justify-items:center;
      text-align:center;
      overflow:visible; /* ã¯ã¿å‡ºã—ã‚’è¦‹ã›ã‚‹ */
      gap:0;           /* ä½™ç™½ã‚¼ãƒ­ */
    }

    .pet-name{
      position:absolute; top:8px; font-size:clamp(18px,4.2vw,22px);
      color:#A3A649; letter-spacing:.03em; z-index:3;
    }

    .pet-canvas{
      position:relative;         /* â† ãƒœã‚¿ãƒ³ã®åŸºæº–ã«ã™ã‚‹ */
      display:grid; place-items:center;
      width:fit-content;
    }

    #petCanvas{
      width:min(82dvw,400px) !important;
      max-height:54vh !important;
      margin:0 auto 0 !important; /* ä¸‹ä½™ç™½ã‚¼ãƒ­ï¼ˆé‡ã­ã‚‹ã®ã§ä¸è¦ï¼‰ */
      background:none; border:none; box-shadow:none; border-radius:0;
      display:grid; place-items:center; position:relative;
    }

    .pet-canvas img{
      width:100%; height:auto; object-fit:contain; display:block; transform-origin:50% 80%;
    }

    .fx-layer{ position:absolute; inset:0; pointer-events:none; z-index:2; }


    /* ã“ã“ãŒé‡ã­ã‚‹è‚ï¼šç”»åƒã®ä¸­ã«çµ¶å¯¾é…ç½® */
    .row-overlay{
      position:absolute;
      left:0; right:0;
      bottom:calc(var(--overlap) * -1); /* ä¸‹ç«¯ã‹ã‚‰é£Ÿã„ä¸‹ãŒã‚‹é‡ï¼ˆé‡ãªã‚Šï¼‰ */
      display:flex; justify-content:center;
      z-index:4; /* ç”»åƒã‚ˆã‚Šä¸Š */
      pointer-events:auto;
    }

    #feedBtn{
      font-size:19px; padding:12px 22px; margin:0 !important;
      box-shadow:0 4px 14px rgba(0,0,0,.12);
    }

    .log{ font-size:12px; color:var(--sub); display:grid; gap:6px; max-height:22vh; overflow:auto; }
    .log-item{ background:#fff; border:1px dashed var(--line); border-radius:8px; padding:6px 8px; }

    /* ã‚¿ãƒ–ãƒãƒ¼ */
    .tabbar{
      position:absolute; bottom:0; left:0; width:100%;
      display:grid; grid-template-columns:repeat(5,1fr); gap:6px;
      background:#fff; border-top:2px solid var(--line2);
      padding:6px 6px calc(6px + env(safe-area-inset-bottom));
      height:var(--tabbar-h); box-sizing:border-box;
      flex-shrink:0;
    }
    .tabbar .tab{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      border:1px solid var(--line); border-radius:14px; background:#fff7f1;
      font-size:11px; color:#444; cursor:pointer; padding:8px 4px 6px;
    }
    .tabbar .tab i{ font-size:20px; line-height:1; }
    .tabbar .tab.active{ background:#ffe6d7; border-color:#ffccb3; color:#A3A649; }
    .tabbar .tab:focus-visible{ outline:2px solid #ffb999; outline-offset:2px; }
  </style>
</head>
<body data-page="main">
  <div class="phone">
    <div class="screen">
      <div class="island" aria-hidden="true"></div>
      <!-- ã”ã¯ã‚“é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="foodModal" aria-hidden="true"
          style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:9999;">
        <div role="dialog" aria-modal="true" aria-labelledby="foodTitle"
            style="background:#fff; border:2px solid var(--line2); border-radius:16px; width:min(92vw,520px); max-width:520px; padding:16px; box-shadow:0 14px 40px rgba(0,0,0,.18);">
          <h3 id="foodTitle" style="margin:0 0 8px; font-size:18px;">ã”ã¯ã‚“ã‚’ãˆã‚‰ã¶</h3>

          <p style="margin:0 0 8px; color:var(--sub); font-size:13px;">ä»Šæ—¥ã®ã”ã¯ã‚“ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ•™ãˆã¦ã­</p>

          <form id="foodForm" style="display:grid; gap:10px; font-size:14px;">
            <fieldset style="border:none; padding:0; margin:0;">
              <legend style="font-weight:700; margin-bottom:6px;">ä¸»èœï¼ˆã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼‰</legend>
              <label><input type="radio" name="protein" value="low"  required> ã™ããªã‚ï¼ˆè±†è…ãƒ»åµå°‘ã—ï¼‰</label>
              <label><input type="radio" name="protein" value="mid"> ãµã¤ã†ï¼ˆé¶ãƒ»é­šãªã©é©é‡ï¼‰</label>
              <label><input type="radio" name="protein" value="high"> ãŠãŠã‚ï¼ˆç‰›ãƒ»è±šãƒ»æšã’ç‰©ãŸã£ã·ã‚Šï¼‰</label>
            </fieldset>

            <fieldset style="border:none; padding:0; margin:0;">
              <legend style="font-weight:700; margin-bottom:6px;">é‡èœãƒ»æœç‰©</legend>
              <label><input type="radio" name="veggie" value="low"  required> ã™ããªã‚</label>
              <label><input type="radio" name="veggie" value="mid"> ãµã¤ã†</label>
              <label><input type="radio" name="veggie" value="high"> ãŸã£ã·ã‚Š</label>
            </fieldset>

            <fieldset style="border:none; padding:0; margin:0;">
              <legend style="font-weight:700; margin-bottom:6px;">ä¸»é£Ÿï¼ˆã”ã¯ã‚“ãƒ»ãƒ‘ãƒ³ç­‰ï¼‰</legend>
              <label><input type="radio" name="carb" value="low"  required> ã™ããªã‚</label>
              <label><input type="radio" name="carb" value="mid"> ãµã¤ã†</label>
              <label><input type="radio" name="carb" value="high"> ãŠãŠã‚</label>
            </fieldset>

            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
              <button type="button" id="foodCancel" class="btn" style="background:#fff7f1; border:1px solid var(--line);">ã‚„ã‚ã‚‹</button>
              <button type="submit" class="btn" id="foodOK">OK</button>
            </div>
          </form>
        </div>
      </div>

      <main id="app" class="fade">
        <section class="hero">
          <div class="app-title">ãƒšãƒƒãƒˆã¨<br>ã”ã¯ã‚“ã®æ™‚é–“</div>
          <div class="lead">ã€Œã”ã¯ã‚“ã€ãƒœã‚¿ãƒ³ã§è‚²ã¦ã‚ˆã†ï¼</div>
        </section>

        <section class="main-wrap">
          <article class="card">
            <div class="pet-stage">
              <div class="pet-canvas" id="petCanvas">
                <div id="petMeta" class="pet-name"></div>
                <img id="petImg" src="./assets/img/pets/placeholder.png" alt="ãƒšãƒƒãƒˆ" decoding="async" loading="lazy">
                <div class="fx-layer" id="fx">
                  <img id="sparkleFx" src="./assets/gif/kirakira.gif"
       alt="" style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:none;">
                </div>
                <!-- ç”»åƒã®ä¸Šã«å‹•ç”»ï¼ˆå†ç”Ÿæ™‚ã ã‘è¡¨ç¤ºï¼‰ -->
                <video id="petAnim"
                       playsinline
                       muted
                       preload="auto"
                       poster="./assets/img/pets/placeholder.png"
                       style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:none; z-index:2;">
                  <!-- WebMå„ªå…ˆï¼‹MP4ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ã‚Œã°ï¼‰ -->
                  <!-- ã‚½ãƒ¼ã‚¹ã¯JSã§åˆ‡ã‚Šæ›¿ãˆã‚‹ã®ã§æœ€åˆã¯ç©ºã§OK -->
                </video>
                <div class="row-overlay">
                  <button id="feedBtn" class="btn" type="button">ğŸ™ ã”ã¯ã‚“ã‚’ã‚ã’ã‚‹</button>
                </div>
              </div>
            </div>
          </article>

          <article class="card">
            <h3 style="margin:0; font-size:16px;">ãã‚ã</h3>
            <div id="log" class="log" aria-live="polite"></div>
          </article>
        </section>
      </main>

      <nav class="tabbar" role="navigation" aria-label="ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“">
        <button class="tab" aria-label="ãƒã‚¤ãƒšãƒ¼ã‚¸" onclick="location.href='mypage.html'">
          <i class="fa-solid fa-user"></i><span>My Page</span>
        </button>
        <button class="tab" aria-label="ç€ã›æ›¿ãˆ" onclick="location.href='accessory.html'">
          <i class="fa-solid fa-shirt"></i><span>ç€ã›æ›¿ãˆ</span>
        </button>
        <button class="tab active" aria-current="page" aria-label="ãƒ›ãƒ¼ãƒ " onclick="location.href='main.html'">
          <i class="fa-solid fa-house"></i><span>Home</span>
        </button>
        <button class="tab" aria-label="å‹ã ã¡" onclick="location.href='friends.html'">
          <i class="fa-solid fa-user-group"></i><span>å‹ã ã¡</span>
        </button>
        <button class="tab" aria-label="è¨­å®š" onclick="location.href='settings.html'">
          <i class="fa-solid fa-gear"></i><span>è¨­å®š</span>
        </button>
      </nav>
    </div>
  </div>

  <script type="module">
  const KEY_PET='tky.pet', KEY_PET_NAME='tky.petName';
  const $=(s,r=document)=>r.querySelector(s);
  function loadJSON(k,f=null){try{const r=localStorage.getItem(k);return r?JSON.parse(r):f;}catch{return f}}

  const pet=loadJSON(KEY_PET,null);
  const petName=localStorage.getItem(KEY_PET_NAME)||'';
  const PLACEHOLDER="./assets/img/pets/placeholder.png";

  function candidatesFrom(src){
    const set=new Set();
    if(src) set.add(src);
    const a=src?.replace("/assets/pets/","/assets/img/pets/");
    const b=a?.replace(/^\.?\/img\//,"./assets/img/");
    if(b) set.add(b);
    if(b?.startsWith("/")) set.add("."+b);
    if(b?.startsWith("./")) set.add(b.slice(1));
    const file=(src||"").split("/").pop();
    if(file && !file.includes(".")) set.add(`./assets/img/pets/${file}.png`);
    else if(file) set.add(`./assets/img/pets/${file}`);
    if(b) set.add(b.replace(/^\.\//,"/"));
    set.add(PLACEHOLDER);
    return Array.from(set);
  }
  function resolveAndLoad(src,imgEl){
    const tries=candidatesFrom(src); let i=0;
    (function next(){
      if(i>=tries.length){ imgEl.src=PLACEHOLDER; return; }
      const s=tries[i++], probe=new Image();
      probe.onload=()=>{ imgEl.src=s; };
      probe.onerror=()=>next();
      probe.src=s+(s.includes("?")?"&":"?")+"v="+Date.now();
    })();
  }

  (function render(){
  const imgEl=$('#petImg');
  const nameEl=$('#petMeta');
  if(!imgEl) return;

  // ã™ã§ã«è¦‹ãŸç›®ãŒæ±ºã¾ã£ã¦ã„ã‚‹ãªã‚‰åˆæœŸè¡¨ç¤ºã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¾Œã§applyAppearanceãŒä¸Šæ›¸ãã™ã‚‹ï¼‰
  const apRaw = localStorage.getItem('tky.appearance');
  if (apRaw) {
    const typeLabel=pet?.label||pet?.id||'ãƒšãƒƒãƒˆ';
    if(nameEl) nameEl.textContent = petName ? `${petName}ï¼ˆ${typeLabel}ï¼‰` : `${typeLabel}`;
    return;
  }

  if(!pet){ imgEl.src=PLACEHOLDER; if(nameEl) nameEl.textContent=''; return; }
  const typeLabel=pet.label||pet.id||'ãƒšãƒƒãƒˆ';
  if(nameEl) nameEl.textContent = petName ? `${petName}ï¼ˆ${typeLabel}ï¼‰` : `${typeLabel}`;
  imgEl.alt=`${typeLabel} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼`;
  resolveAndLoad(pet.img||PLACEHOLDER,imgEl);
})();


  // ===== ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ =====
  const modal = $('#foodModal');
  const feedBtn = $('#feedBtn');
  const foodForm = $('#foodForm');
  const foodCancel = $('#foodCancel');
  const petImg = $('#petImg');
  const petAnim = $('#petAnim');
  const logEl = $('#log');

  function openModal(){
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  feedBtn?.addEventListener('click', openModal);
  foodCancel?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

  // ===== ã‚‚ãã‚‚ãå†ç”Ÿã ã‘ã‚„ã‚‹ï¼ˆ1å›è¡¨ç¤ºâ†’é™æ­¢ç”»ã¸æˆ»ã™ï¼‰ =====
// ãƒ•ã‚¡ã‚¤ãƒ«å ´æ‰€ï¼š assets/gif/mogumogu.gif
const CHEW_SRC = { gif: './assets/gif/mogumogu.gif' };
let chewing = false;

async function playChewOnce() {
  if (chewing) return;
  chewing = true;

  // ã‚‚ãã‚‚ãGIFã‚’ç”»åƒã¨ã—ã¦å·®ã—æ›¿ãˆã‚‹
  const originalSrc = petImg.src; // å…ƒã®ç”»åƒã‚’ä¿å­˜
  petImg.src = CHEW_SRC.gif;

  // GIFã®å†ç”Ÿæ™‚é–“åˆ†ã ã‘å¾…ã¤ï¼ˆ2ã€œ3ç§’ã‚’ç›®å®‰ã«èª¿æ•´ï¼‰
  await new Promise(r => setTimeout(r, 3000));

  // çµ‚äº†å¾Œã€å…ƒã®ç”»åƒã«æˆ»ã™
  petImg.src = originalSrc;
  chewing = false;
}

  // ===== é€ä¿¡ã§ãƒ­ã‚°è¿½åŠ  â†’ ã‚‚ãã‚‚ãå†ç”Ÿ =====
  foodForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(foodForm);
    const data = {
      protein: fd.get('protein'),
      veggie:  fd.get('veggie'),
      carb:    fd.get('carb'),
    };
    closeModal();

    addLogRow(data, 'chew'); // ã„ã¾ã¯ã€Œã‚‚ãã‚‚ãã€å›ºå®š

    await playChewOnce();
  });

  function addLogRow(data, kind){
    const now = new Date();
    const jst = now.toLocaleString('ja-JP', { hour12:false });
    const mapJP = { low:'ã™ããªã‚', mid:'ãµã¤ã†', high:'ãŠãŠã‚' };
    const label = 'ğŸ™ ã‚‚ãã‚‚ã';
    const div = document.createElement('div');
    div.className = 'log-item';
    div.innerHTML =
      `<strong>${label}</strong> <span style="color:#888;">${jst}</span><br>
       ä¸»èœ: ${mapJP[data.protein]} / é‡èœ: ${mapJP[data.veggie]} / ä¸»é£Ÿ: ${mapJP[data.carb]}`;
    logEl?.prepend(div);
  }
  /* ========= ã“ã“ã‹ã‚‰ â€œæ—¥æ¬¡åˆ¤å®š + è¦‹ãŸç›®ç¶­æŒâ€ ã®è¿½åŠ ã‚³ãƒ¼ãƒ‰ ========= */

// --- è¨­å®šï¼ˆã—ãã„å€¤ãƒ»é€£ç¶šæ—¥æ•°ãƒ»æ¼”å‡ºæ™‚é–“msï¼‰ ---
const ENERGY_SCORE = { low: 1, mid: 2, high: 3 }; // é‡ã‚¹ã‚³ã‚¢ï¼ˆä¸»èœ/ä¸»é£Ÿã«åŠ¹ãï¼‰
const VEGGIE_BONUS = { low: 0, mid: 1, high: 2 }; // é‡èœãƒœãƒ¼ãƒŠã‚¹
const FAT_THRESHOLD   = 8;  // ã“ã‚Œä»¥ä¸Šã§ã€Œå¤šã„ã€â†’ fat
const THIN_THRESHOLD  = 3;  // ã“ã‚Œæœªæº€ã§ã€Œå°‘ãªã„ã€
const THIN_STREAK_N   = 2;  // å°‘ãªã„æ—¥ãŒé€£ç¶šNæ—¥ã§thin
const SPARKLE_RULE = (p, v, c) => (
  // ãƒãƒ©ãƒ³ã‚¹åˆ¤å®šä¾‹ï¼šå…¨éƒ¨mid ã‹ã€é‡èœhigh ã‹ã¤ ä»–ãŒmidä»¥ä¸‹
  (p==='mid' && v==='mid' && c==='mid') ||
  (v==='high' && (p!=='high' && c!=='high'))
);

const TRANSITION_GIF_MS = 2200; // to_fat / to_thin ã®GIFé•·ã•ï¼ˆmp4ãªã‚‰ ended ã§OKï¼‰

// --- ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼ ---
const KEY_MEAL_LOG   = 'tky.mealLog';     // { 'YYYY-MM-DD': [ {protein, veggie, carb, ts}, ... ] }
const KEY_APPEARANCE = 'tky.appearance';  // { petId, state, since:'YYYY-MM-DD', lastEval:'YYYY-MM-DD' }
const KEY_PET        = 'tky.pet';

// --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆæ—¥ä»˜ã¯ãƒ­ãƒ¼ã‚«ãƒ«åŸºæº–ã§OKï¼‰ ---
const fmtDate = (d=new Date()) => d.toISOString().slice(0,10);
const yesterdayStr = () => {
  const d = new Date(); d.setDate(d.getDate()-1);
  return fmtDate(d);
};

// --- ãƒ­ã‚°ä¿å­˜ï¼ˆæ—¢å­˜logUIã«åŠ ãˆã¦æ—¥æ¬¡é›†è¨ˆã®ãŸã‚ã«ä¿å­˜ï¼‰ ---
function saveMealForToday(entry){ // entry: {protein, veggie, carb}
  const raw = localStorage.getItem(KEY_MEAL_LOG);
  const log = raw ? JSON.parse(raw) : {};
  const today = fmtDate();
  if(!log[today]) log[today] = [];
  log[today].push({...entry, ts: Date.now()});
  localStorage.setItem(KEY_MEAL_LOG, JSON.stringify(log));
}

// æ—¢å­˜ã® foodForm submit ã®ä¸­ã§ã€ãƒ­ã‚°è¿½åŠ ã®ç›´å¾Œã«å‘¼ã¶ã¨ã‚ˆã„ï¼š
// saveMealForToday(data);

// --- å‰æ—¥ã‚’é›†è¨ˆã—ã¦å¤–è¦‹ã‚’æ±ºã‚ã‚‹ ---
function evaluateDay(dayStr){ // return {state:'normal|fat|thin|sparkle', energy, info }
  const raw = localStorage.getItem(KEY_MEAL_LOG);
  const log = raw ? JSON.parse(raw) : {};
  const items = log[dayStr] || [];
  if(items.length===0) return { state:'normal', energy:0, info:{ reason:'no_meal' } };

  // 1æ—¥ã®åˆè¨ˆã‚¹ã‚³ã‚¢
  let energy = 0;
  let balanced = false;
  for(const it of items){
    energy += (ENERGY_SCORE[it.protein]||0) + (ENERGY_SCORE[it.carb]||0) + (VEGGIE_BONUS[it.veggie]||0);
    if (SPARKLE_RULE(it.protein, it.veggie, it.carb)) balanced = true;
  }

  // ä»®ã®ãƒ«ãƒ¼ãƒ«ï¼šbalancedãªã‚‰ sparkle ã‚’æœ€å„ªå…ˆ
  if (balanced) return { state:'sparkle', energy, info:{ reason:'balanced' } };
  if (energy >= FAT_THRESHOLD) return { state:'fat', energy, info:{ reason:'high_energy' } };

  // thin ã¯ â€œå°‘ãªã„æ—¥â€ ãŒé€£ç¶š N æ—¥
  const isThinDay = energy < THIN_THRESHOLD;
  if (isThinDay) {
    const streak = countThinStreakEndingAt(dayStr);
    if (streak >= THIN_STREAK_N) return { state:'thin', energy, info:{ reason:'thin_streak', streak } };
  }

  return { state:'normal', energy, info:{ reason:'default' } };
}

function countThinStreakEndingAt(dayStr){
  const raw = localStorage.getItem(KEY_MEAL_LOG);
  const log = raw ? JSON.parse(raw) : {};
  let streak = 0;
  let d = new Date(dayStr);
  // å¾Œã‚å‘ãã« â€œå°‘ãªã„æ—¥â€ ã‚’æ•°ãˆã‚‹
  for(;;){
    const key = fmtDate(d);
    const items = log[key] || [];
    let energy = 0;
    for(const it of items){
      energy += (ENERGY_SCORE[it.protein]||0) + (ENERGY_SCORE[it.carb]||0) + (VEGGIE_BONUS[it.veggie]||0);
    }
    if (items.length>0 && energy < THIN_THRESHOLD){
      streak += 1;
      d.setDate(d.getDate()-1);
    } else {
      break;
    }
  }
  return streak;
}

// --- è¦‹ãŸç›®çŠ¶æ…‹ã®ä¿å­˜/å–å¾— ---
function getAppearance(){
  const raw = localStorage.getItem(KEY_APPEARANCE);
  return raw ? JSON.parse(raw) : null;
}
function setAppearance(obj){
  localStorage.setItem(KEY_APPEARANCE, JSON.stringify(obj));
}

// --- ç”»åƒ/ã‚¢ãƒ‹ãƒ¡ã®é©ç”¨ ---
const sparkleFx = document.getElementById('sparkleFx');

function petIdOrDefault(){
  const pet = loadJSON(KEY_PET,null);
  return pet?.id || 'pet'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆid
}

function assetExists(path){
  // ç”»åƒã¯ 404 ã§ã‚‚ <img> ã¯ event ã§æ‹¾ãˆã‚‹ãŒã€ã“ã“ã¯â€œè©¦ã—å·®ã—æ›¿ãˆâ€ã«ä»»ã›ã‚‹ç°¡æ˜“é‹ç”¨
  return path; // ãã®ã¾ã¾è¿”ã—ã¦å€™è£œã«ã™ã‚‹ï¼ˆå¤±æ•—æ™‚ã¯ onerror ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
}

function staticSpriteFor(state){
  // ã„ã¾ã®é…ç½®ï¼š ./assets/fat.jpg, ./assets/thin.jpg, ./assets/kirakira.jpg
  switch(state){
    case 'fat':    return './assets/fat.jpg';
    case 'thin':   return './assets/thin.jpg';
    case 'sparkle':return './assets/kirakira.jpg'; // ç„¡ã‘ã‚Œã° PLACEHOLDER ã«å¤‰æ›´OK
    default:       return './assets/kirakira.jpg';
  }
}

function transitionAnimFor(state){ // ./assets/gif/ é…ä¸‹
  if (state==='fat')  return { gif: './assets/gif/fat.gif',  ms: TRANSITION_GIF_MS };
  if (state==='thin') return { gif: './assets/gif/thin.gif', ms: TRANSITION_GIF_MS };
  return null;
}

function transitionAnimFor(state){ // ./assets/gif/ é…ä¸‹
  if (state==='fat')  return { gif: './assets/gif/fat.gif',  ms: TRANSITION_GIF_MS };
  if (state==='thin') return { gif: './assets/gif/thin.gif', ms: TRANSITION_GIF_MS };
  return null;
}

async function applyAppearance(state, {playTransitionIfAny=false}={}){
  // sparkleã¯ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å¸¸æ™‚ON/OFF
  sparkleFx.style.display = (state==='sparkle') ? 'block' : 'none';

  const targetStatic = staticSpriteFor(state);

  // fat/thin ã¸â€œä»Šæ—¥åˆã‚ã¦â€å¤‰ã‚ã‚‹æ™‚ã ã‘é·ç§»ã‚¢ãƒ‹ãƒ¡ã‚’1å›è¡¨ç¤ºï¼ˆGIFæƒ³å®šï¼‰
  if (playTransitionIfAny && (state==='fat' || state==='thin')) {
    const trans = transitionAnimFor(state);
    if (trans?.gif) {
      const originalSrc = petImg.src;
      petImg.src = trans.gif;
      await new Promise(r => setTimeout(r, trans.ms)); // GIFã¯endedå–ã‚Œãªã„ã®ã§æ™‚é–“ã§æˆ»ã™
      petImg.src = targetStatic;
      return;
    }
  }

  // é€šå¸¸ã¯é™æ­¢ç”»åƒã¸
  petImg.src = targetStatic;
}

// --- èµ·å‹•æ™‚ï¼šå‰æ—¥ã‚’è©•ä¾¡ã—ã¦çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆåˆå›ã®ã¿ï¼‰ ---
(function dailyEvaluateIfNeeded(){
  const today  = fmtDate();
  const yest   = yesterdayStr();
  const ap     = getAppearance();
  const id     = petIdOrDefault();

  if (!ap || ap.lastEval !== today) {
    // å‰æ—¥ã«ã¤ã„ã¦åˆ¤å®šã—ã¦ä»Šæ—¥ã®è¦‹ãŸç›®ã«åæ˜ 
    const result = evaluateDay(yest);
    const state  = result.state;

    const prevState = ap?.state;
    const changedToday = (state !== prevState);

    setAppearance({
      petId: id,
      state,
      since: (changedToday ? today : (ap?.since || today)),
      lastEval: today
    });

    // å¤‰ã‚ã£ãŸæ™‚ã ã‘é·ç§»ã‚¢ãƒ‹ãƒ¡ã‚’å†ç”Ÿ
    applyAppearance(state, { playTransitionIfAny: changedToday });
  } else {
    // ã™ã§ã«ä»Šæ—¥è©•ä¾¡æ¸ˆã¿ãªã‚‰ä¿å­˜ã•ã‚ŒãŸè¦‹ãŸç›®ã‚’å†é©ç”¨
    applyAppearance(ap.state, { playTransitionIfAny: false });
  }
})();

// --- é£Ÿäº‹ãƒ•ã‚©ãƒ¼ãƒ  submit æ™‚ï¼šæ—¥æ¬¡ãƒ­ã‚°ã«åŠ ç®—ï¼ˆæ—¢å­˜ã®å‡¦ç†ã«1è¡Œè¿½åŠ ï¼‰ ---
// æ—¢å­˜ã® foodForm submit ãƒãƒ³ãƒ‰ãƒ©ã®ä¸­ï¼ˆaddLogRow ã®å‰å¾ŒãŠå¥½ããªä½ç½®ï¼‰ã«ï¼š
// saveMealForToday(data);

/* ========= è¿½åŠ ã‚³ãƒ¼ãƒ‰ã“ã“ã¾ã§ ========= */
// ç”»åƒã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚’å¯è¦–åŒ–
const dbg = (msg)=>console.log('[pet-img]', msg);
petImg.addEventListener('error', ()=>dbg('ERROR loading '+petImg.src));
petImg.addEventListener('load',  ()=>dbg('LOADED '+petImg.src));

// applyAppearance ã®æœ«å°¾ã«ãƒ­ã‚°ã‚’å…¥ã‚Œã‚‹ã¨ç¢ºèªã—ã‚„ã™ã„
async function applyAppearance(state, {playTransitionIfAny=false}={}){
  sparkleFx.style.display = (state==='sparkle') ? 'block' : 'none';
  const targetStatic = staticSpriteFor(state);

  if (playTransitionIfAny && (state==='fat' || state==='thin')) {
    const trans = transitionAnimFor(state);
    if (trans?.gif) {
      console.log('[appearance] transition', state, 'â†’', trans.gif);
      const originalSrc = petImg.src;
      petImg.src = trans.gif;
      await new Promise(r => setTimeout(r, trans.ms));
      petImg.src = targetStatic;
      console.log('[appearance] static â†’', targetStatic);
      return;
    }
  }

  console.log('[appearance] static â†’', targetStatic);
  petImg.src = targetStatic;
}


</script>

</body>
</html>
