<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãŸã¹ãã‚ƒã‚‰ | ãƒ¡ã‚¤ãƒ³</title>
  <link href="https://fonts.googleapis.com/css2?family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">

  <style>
    :root{
      --top-gap: clamp(16px, 6vh, 56px);
      --overlap: 10px;
    }

    html,body{
      height:100%; margin:0;
      font-family:"Hachi Maru Pop",cursive;
      background:var(--bg);
    }

    .phone,.screen{
      height:100svh; display:flex; flex-direction:column;
      overflow:hidden;
    }

    main{
      flex:1; display:flex; flex-direction:column; align-items:center;
      justify-content:flex-start;
      padding:8px 16px calc(var(--tabbar-h) + env(safe-area-inset-bottom));
      box-sizing:border-box;
      overflow:hidden;
    }

    .hero{ display:grid; place-items:center; text-align:center; gap:6px; padding:16px 16px 4px; margin-top:44px; }
    .app-title{ font-size:clamp(22px,5.2vw,30px); font-weight:900; letter-spacing:.08em; -webkit-text-stroke:1px rgba(0,0,0,.06); line-height:1.05; }
    .lead{ color:var(--sub); font-size:13px; }

    .main-wrap{ display:grid; gap:12px; padding:20px 16px 0; }
    .card{ background:none; border:none; box-shadow:none; border-radius:0; display:grid; gap:10px; margin-top:6px; }

    .pet-stage{ position:relative; display:grid; justify-items:center; text-align:center; overflow:visible; gap:0; }
    .pet-name{ position:absolute; top:8px; font-size:clamp(18px,4.2vw,22px); color:#A3A649; letter-spacing:.03em; z-index:3; }
    .pet-canvas{ position:relative; display:grid; place-items:center; width:fit-content; }
    #petCanvas{ width:min(82dvw,400px)!important; max-height:54vh!important; margin:0 auto 0!important; background:none; border:none; display:grid; place-items:center; position:relative; }
    .pet-canvas img{ width:100%; height:auto; object-fit:contain; display:block; transform-origin:50% 80%; }
    .row-overlay{ position:absolute; left:0; right:0; bottom:calc(var(--overlap) * -1); display:flex; justify-content:center; z-index:4; }
    #feedBtn{ font-size:19px; padding:12px 22px; margin:0!important; box-shadow:0 4px 14px rgba(0,0,0,.12); }

    .log{ font-size:12px; color:var(--sub); display:grid; gap:6px; max-height:22vh; overflow:auto; }
    .log-item{ background:#fff; border:1px dashed var(--line); border-radius:8px; padding:6px 8px; }

    .tabbar{
      position:absolute; bottom:0; left:0; width:100%;
      display:grid; grid-template-columns:repeat(5,1fr); gap:6px;
      background:#fff; border-top:2px solid var(--line2);
      padding:6px 6px calc(6px + env(safe-area-inset-bottom));
      height:var(--tabbar-h); box-sizing:border-box; flex-shrink:0;
    }
    .tabbar .tab{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      border:1px solid var(--line); border-radius:14px; background:#fff7f1;
      font-size:11px; color:#444; cursor:pointer; padding:8px 4px 6px;
    }
    .tabbar .tab i{ font-size:20px; line-height:1; }
    .tabbar .tab.active{ background:#ffe6d7; border-color:#ffccb3; color:#A3A649; }

    /* === ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆä¸­å¤®ã‚«ãƒ¼ãƒ‰å‹ï¼‰ === */
    .screen{ position:relative; overflow:hidden; }
    .modal-backdrop{
      position:absolute; inset:0; display:none;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,.25);
      backdrop-filter:saturate(120%) blur(2px);
      z-index:100; transition:opacity .25s ease; opacity:0;
    }
    .modal-backdrop[aria-hidden="false"]{ display:flex; opacity:1; }
    .modal-dialog{
      background:#fffaf7; border:2px solid var(--line2); border-radius:20px;
      box-shadow:0 8px 30px rgba(0,0,0,.15);
      width:90%; max-width:360px; max-height:80%;
      padding:20px 20px 16px; overflow-y:auto;
      animation: popIn .25s ease-out both; font-family:"Hachi Maru Pop",cursive;
    }
    .modal-dialog h3{ font-size:18px; margin:0 0 6px; color:#444; }
    .modal-lead{ margin:0 0 12px; color:var(--sub); font-size:13px; }
    .modal-form{ display:grid; gap:14px; font-size:15px; }
    .modal-form fieldset{ border:none; margin:0; padding:0; display:grid; gap:6px; }
    .modal-form legend{ font-weight:700; font-size:15px; margin-bottom:4px; color:#553; }
    .modal-form label{ background:#fff7f1; border:1px solid var(--line); border-radius:12px;
      padding:10px 12px; display:flex; align-items:flex-start; gap:10px; transition:background .2s, transform .1s; }
    .modal-form label:hover{ background:#ffe9de; transform:translateY(-1px); }
    .modal-form input[type="radio"]{ transform:scale(1.2); accent-color:#A3A649; }
    .modal-form label div{ display:flex; flex-direction:column; line-height:1.3; }
    .modal-form small{ font-size:12px; color:#777; }
    .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; padding-top:12px; border-top:1px solid var(--line2); }
    @keyframes popIn{ from{opacity:0; transform:scale(.95);} to{opacity:1; transform:scale(1);} }
  </style>
</head>

<body data-page="main">
  <div class="phone">
    <div class="screen">
      <main id="app">
        <section class="hero">
          <div class="app-title">ãƒšãƒƒãƒˆã¨<br>ã”ã¯ã‚“ã®æ™‚é–“</div>
          <div class="lead">ã€Œã”ã¯ã‚“ã€ãƒœã‚¿ãƒ³ã§è‚²ã¦ã‚ˆã†ï¼</div>
        </section>

        <section class="main-wrap">
          <article class="card">
            <div class="pet-stage">
              <div class="pet-canvas" id="petCanvas">
                <div id="petMeta" class="pet-name"></div>
                <img id="petImg" src="./assets/img/placeholder.png" alt="ãƒšãƒƒãƒˆ">
                <div class="row-overlay">
                  <button id="feedBtn" class="btn" type="button">ğŸ™ ã”ã¯ã‚“ã‚’ã‚ã’ã‚‹</button>
                </div>
              </div>
            </div>
          </article>

          <article class="card">
            <h3 style="margin:0; font-size:16px;">ãã‚ã</h3>
            <div id="log" class="log" aria-live="polite"></div>
          </article>
        </section>
      </main>

      <!-- ã”ã¯ã‚“ãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="foodModal" class="modal-backdrop" aria-hidden="true">
        <div role="dialog" aria-modal="true" aria-labelledby="foodTitle" class="modal-dialog">
          <h3 id="foodTitle">ã”ã¯ã‚“ã‚’ãˆã‚‰ã¶</h3>
          <p class="modal-lead">ä»Šæ—¥ã®ã”ã¯ã‚“ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ•™ãˆã¦ã­</p>
          <form id="foodForm" class="modal-form">
            <fieldset>
              <legend>ä¸»èœï¼ˆã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼‰</legend>
              <label><input type="radio" name="protein" value="low" required><div><div>ã™ããªã‚</div><small>ï¼ˆè±†è…ãƒ»åµå°‘ã—ãªã©è»½ã‚ï¼‰</small></div></label>
              <label><input type="radio" name="protein" value="mid"><div><div>ãµã¤ã†</div><small>ï¼ˆé¶ã‚„é­šãªã©ã‚’ã—ã£ã‹ã‚Šä¸€å“ï¼‰</small></div></label>
              <label><input type="radio" name="protein" value="high"><div><div>ãŠãŠã‚</div><small>ï¼ˆç‰›ãƒ»è±šãƒ»æšã’ç‰©ãŸã£ã·ã‚Šï¼‰</small></div></label>
            </fieldset>
            <fieldset>
              <legend>é‡èœãƒ»æœç‰©</legend>
              <label><input type="radio" name="veggie" value="low" required><div><div>ã™ããªã‚</div><small>ï¼ˆé‡èœãªã—ãƒ»å°‘ã—ï¼‰</small></div></label>
              <label><input type="radio" name="veggie" value="mid"><div><div>ãµã¤ã†</div><small>ï¼ˆã‚µãƒ©ãƒ€ã‚„å‰¯èœ1ã€œ2å“ï¼‰</small></div></label>
              <label><input type="radio" name="veggie" value="high"><div><div>ãŸã£ã·ã‚Š</div><small>ï¼ˆé‡èœä¸­å¿ƒãƒ»æœç‰©ã‚‚â—ï¼‰</small></div></label>
            </fieldset>
            <fieldset>
              <legend>ä¸»é£Ÿï¼ˆã”ã¯ã‚“ãƒ»ãƒ‘ãƒ³ç­‰ï¼‰</legend>
              <label><input type="radio" name="carb" value="low" required><div><div>ã™ããªã‚</div><small>ï¼ˆå°‘ãªã‚ãƒ»åŠåˆ†é‡ï¼‰</small></div></label>
              <label><input type="radio" name="carb" value="mid"><div><div>ãµã¤ã†</div><small>ï¼ˆãŠèŒ¶ç¢—1æ¯ãƒ»ãƒ‘ãƒ³1æšã»ã©ï¼‰</small></div></label>
              <label><input type="radio" name="carb" value="high"><div><div>ãŠãŠã‚</div><small>ï¼ˆãŠã‹ã‚ã‚Šãƒ»éººï¼‹ã”é£¯ãªã©ï¼‰</small></div></label>
            </fieldset>
            <div class="modal-actions">
              <button type="button" id="foodCancel" class="btn" style="background:#fff7f1; border:1px solid var(--line);">ã‚„ã‚ã‚‹</button>
              <button type="submit" class="btn" id="foodOK">OK</button>
            </div>
          </form>
        </div>
      </div>

      <nav class="tabbar">
        <button class="tab" onclick="location.href='mypage.html'"><i class="fa-solid fa-user"></i><span>My Page</span></button>
        <button class="tab" onclick="location.href='accessory.html'"><i class="fa-solid fa-shirt"></i><span>ç€ã›æ›¿ãˆ</span></button>
        <button class="tab active" onclick="location.href='main.html'"><i class="fa-solid fa-house"></i><span>Home</span></button>
        <button class="tab" onclick="location.href='friends.html'"><i class="fa-solid fa-user-group"></i><span>å‹ã ã¡</span></button>
        <button class="tab" onclick="location.href='settings.html'"><i class="fa-solid fa-gear"></i><span>è¨­å®š</span></button>
      </nav>
    </div>
  </div>

  <script type="module">
    const K = { PET:'tky.pet', PET_NAME:'tky.petName', MEAL_LOG:'tky.mealLog', APPEARANCE:'tky.appearance' };
    const $ = (s,r=document)=>r.querySelector(s);
    function loadJSON(k,f=null){ try{const r=localStorage.getItem(k); return r?JSON.parse(r):f;}catch{return f;} }
    const pet = loadJSON(K.PET,null);
    const petName = localStorage.getItem(K.PET_NAME)||'';
    const PLACEHOLDER = './assets/img/placeholder.png';
    const petImg = $('#petImg');

    // ====== æ—¥æ¬¡å¤‰åŒ–ãƒ­ã‚¸ãƒƒã‚¯ ======
    const ENERGY_SCORE={low:1,mid:2,high:3};
    const VEGGIE_BONUS={low:0,mid:1,high:2};
    const FAT_THRESHOLD=8, THIN_THRESHOLD=3;
    const FAT_STREAK_N=2, THIN_STREAK_N=2, BALANCED_STREAK_N=2;
    const TRANSITION_GIF_MS=2200;
    const SPARKLE_RULE=(p,v,c)=> (p==='mid'&&v==='mid'&&c==='mid')||(v==='high'&&(p!=='high'&&c!=='high'));

    function staticSpriteFor(state){
      switch(state){
        case 'fat':return'./assets/img/fat.jpg';
        case 'thin':return'./assets/img/thin.jpg';
        case 'sparkle':return'./assets/img/kirakira.jpg';
        default:return(pet?.img||PLACEHOLDER);
      }
    }
    function transitionAnimFor(state){
      if(state==='fat')return{gif:'./assets/gif/fat.gif',ms:TRANSITION_GIF_MS};
      if(state==='thin')return{gif:'./assets/gif/thin.gif',ms:TRANSITION_GIF_MS};
      if(state==='sparkle')return{gif:'./assets/gif/kirakira.gif',ms:TRANSITION_GIF_MS};
      return null;
    }

    function fmtDate(d=new Date()){return d.toISOString().slice(0,10);}
    function yesterdayStr(){const d=new Date();d.setDate(d.getDate()-1);return fmtDate(d);}
    function getAppearance(){return loadJSON(K.APPEARANCE,null);}
    function setAppearance(o){localStorage.setItem(K.APPEARANCE,JSON.stringify(o));}

    function countStreakEndingAt(dayStr,isTargetDay){
      const raw=localStorage.getItem(K.MEAL_LOG);const log=raw?JSON.parse(raw):{};let streak=0;let d=new Date(dayStr);
      for(;;){const key=fmtDate(d);const items=log[key]||[];if(items.length===0)break;
        if(isTargetDay(items)){streak++;d.setDate(d.getDate()-1);}else break;}
      return streak;
    }

    function dayEnergyAndFlags(items){
      let energy=0;let balanced=false;
      for(const it of items){
        energy+=(ENERGY_SCORE[it.protein]||0)+(ENERGY_SCORE[it.carb]||0)+(VEGGIE_BONUS[it.veggie]||0);
        if(SPARKLE_RULE(it.protein,it.veggie,it.carb))balanced=true;
      }
      return{energy,balanced};
    }

    function evaluateDay(dayStr){
      const raw=localStorage.getItem(K.MEAL_LOG);
      const log=raw?JSON.parse(raw):{};
      const items=log[dayStr]||[];
      if(items.length===0)return{state:'normal',info:{reason:'no_meal'}};

      const {energy,balanced}=dayEnergyAndFlags(items);
      const isFatDay=a=>dayEnergyAndFlags(a).energy>=FAT_THRESHOLD;
      const isThinDay=a=>dayEnergyAndFlags(a).energy<THIN_THRESHOLD;
      const isBalDay=a=>dayEnergyAndFlags(a).balanced===true;
      const fatStreak=countStreakEndingAt(dayStr,isFatDay);
      const thinStreak=countStreakEndingAt(dayStr,isThinDay);
      const balStreak=countStreakEndingAt(dayStr,isBalDay);
      if(balStreak>=BALANCED_STREAK_N)return{state:'sparkle'};
      if(fatStreak>=FAT_STREAK_N)return{state:'fat'};
      if(thinStreak>=THIN_STREAK_N)return{state:'thin'};
      return{state:'normal'};
    }

    async function applyAppearance(state, { playTransitionIfAny = false } = {}) {
  // â˜… ã“ã“ãŒé‡è¦ï¼šã‚‚ãã‚‚ãä¸­ãƒ»ãƒ›ãƒ¼ãƒ«ãƒ‰ä¸­ãƒ»é·ç§»ä¸­ã¯ä¸Šæ›¸ãã—ãªã„
  if (Date.now() < eatHoldUntil || isChewing || isTransitioning) return;

  const target = staticSpriteFor(state) + '?t=' + Date.now();

  if (playTransitionIfAny && (state === 'fat' || state === 'thin' || state === 'sparkle')) {
    const trans = transitionAnimFor(state);
    if (trans?.gif) {
      try {
        isTransitioning = true;
        if (petImg) petImg.src = trans.gif + '?t=' + Date.now();
        await new Promise(r => setTimeout(r, trans.ms));
      } finally {
        isTransitioning = false;
      }
    }
  }
  if (petImg) petImg.src = target;
}

    function dailyEvaluateIfNeeded(){
      const today=fmtDate();const yest=yesterdayStr();const ap=getAppearance();
            if(!ap || ap.lastEval!==today){
        const result=evaluateDay(yest);
        const state=result.state;
        const changedToday=(state!==ap?.state);
        setAppearance({
          petId:(pet?.id||'pet'),
          state,
          since:(changedToday?today:(ap?.since||today)),
          lastEval:today
        });
        applyAppearance(state,{playTransitionIfAny:changedToday});
      }else{
        applyAppearance(ap.state,{playTransitionIfAny:false});
      }
    }

    // ====== ã‚‚ãã‚‚ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ ======
    const CHEW_SRC={gif:'./assets/gif/mogumogu.gif',jpg:'./assets/img/mogumogu.jpg'};
    const CHEW_GIF_MS=4000, CHEW_HOLD_MS=12000;
    let eatHoldUntil=0, isChewing=false, chewTimers={gif:null,hold:null};
    let isTransitioning = false;

    function clearChewTimers(){
      if(chewTimers.gif){clearTimeout(chewTimers.gif);}
      if(chewTimers.hold){clearTimeout(chewTimers.hold);}
    }

    async function playChewOnce(){
      clearChewTimers();
      isChewing=true;
      petImg.src=CHEW_SRC.gif+'?t='+Date.now();
      chewTimers.gif=setTimeout(()=>{
        petImg.src=CHEW_SRC.jpg+'?t='+Date.now();
        eatHoldUntil=Date.now()+CHEW_HOLD_MS;
        chewTimers.hold=setTimeout(()=>{eatHoldUntil=0;isChewing=false;},CHEW_HOLD_MS);
      },CHEW_GIF_MS);
    }

    // ====== é£Ÿäº‹å…¥åŠ›å‡¦ç† ======
    const modal=$('#foodModal');
    const foodForm=$('#foodForm');
    const foodCancel=$('#foodCancel');
    const feedBtn=$('#feedBtn');
    const logEl=$('#log');

    function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
    function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
    feedBtn.addEventListener('click',openModal);
    foodCancel.addEventListener('click',closeModal);
    modal.addEventListener('click',e=>{ if(e.target===modal)closeModal(); });

    function saveMealForToday(entry){
      const raw=localStorage.getItem(K.MEAL_LOG);
      const log=raw?JSON.parse(raw):{};
      const today=fmtDate();
      if(!log[today])log[today]=[];
      log[today].push({...entry,ts:Date.now()});
      localStorage.setItem(K.MEAL_LOG,JSON.stringify(log));
    }

    function addLogRow(data){
      const now=new Date();
      const jst=now.toLocaleString('ja-JP',{hour12:false});
      const mapJP={low:'ã™ããªã‚',mid:'ãµã¤ã†',high:'ãŠãŠã‚'};
      const div=document.createElement('div');
      div.className='log-item';
      div.innerHTML=`<strong>ğŸ™ ã‚‚ãã‚‚ã</strong> <span style="color:#888;">${jst}</span><br>
        ä¸»èœ:${mapJP[data.protein]} / é‡èœ:${mapJP[data.veggie]} / ä¸»é£Ÿ:${mapJP[data.carb]}`;
      logEl.prepend(div);
    }

    foodForm.addEventListener('submit',async e=>{
      e.preventDefault();
      const fd=new FormData(foodForm);
      const data={protein:fd.get('protein'),veggie:fd.get('veggie'),carb:fd.get('carb')};
      closeModal();
      addLogRow(data);
      saveMealForToday(data);
      await playChewOnce();
      setTimeout(() => {
        dailyEvaluateIfNeeded();
      }, CHEW_GIF_MS + 200);
    });

    // ====== åˆæœŸæç”» ======
    (function(){
      const nameEl=$('#petMeta');
      if(nameEl) nameEl.textContent = petName ? `${petName}ï¼ˆ${pet?.label||'ãƒšãƒƒãƒˆ'}ï¼‰` : (pet?.label||'ãƒšãƒƒãƒˆ');
      petImg.src=PLACEHOLDER;
      dailyEvaluateIfNeeded();
    })();
  </script>
</body>
</html>

