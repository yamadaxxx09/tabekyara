
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>たべきゃら | メイン</title>
  <link href="https://fonts.googleapis.com/css2?family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">

  <!-- フォント & 既存CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/styles.css" />
  <style>
    :root{
      --top-gap: clamp(16px, 6vh, 56px);
    }
    html,body{
      height:100%;
      margin:0;
      font-family:"Hachi Maru Pop",cursive;
      background:var(--bg);
    }

    /* 画面をスマホ高に合わせる（アドレスバー影響を避けるsvh） */
    .phone, .screen{
      min-height:100svh;
      display: flex;
      flex-direction: column;
      justify-content: space-between; 
    }
    .screen{ display:flex; flex-direction:column; }

    /* コンテンツは下部タブに隠れないようパディングを足す */
    main{
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      padding:8px 16px;
      box-sizing:border-box;
      overflow:hidden !important; /* スクロールをなくす */
    }

    .hero{ display:grid; place-items:center; text-align:center; gap:6px; padding:16px 16px 4px; margin-top: 50px;}
    .app-title{
      
      font-size: clamp(22px, 5.2vw, 30px);
      font-weight: 900;
      letter-spacing: .08em;
      -webkit-text-stroke: 1px rgba(0,0,0,.06);
      line-height: 1.05;      
    }
    .lead{ color:var(--sub); font-size:13px; }

    .main-wrap{ 
      display:grid; 
      gap:12px; 
      padding:25px 16px 16px; 
    }

    .card{
      background: none;   
      border: none;       
      box-shadow: none;      
      border-radius: 0;       
      display: grid;
      gap: 10px;
      margin-top: 20px;
    }


    /* ペット表示 */
    .pet-stage{ 
      display: grid;
      gap: 2px !important;
      justify-items: center;
      text-align: center;
      position: relative;
      margin-bottom: 0 !important;
    }
    .pet-name {
      position: absolute;
      top: -10px; 
      font-size: clamp(18px, 4.2vw, 22px);
      color: #A3A649; 
      letter-spacing: .03em;
    }

    /* 画面内に収まるよう少し小さめ＆比率固定 */
    .pet-canvas{
      width:min(65vw,260px);
      aspect-ratio:1/1;
      max-height:45vh;
      display:grid;
      place-items:center;
      position:relative;
      overflow:visible;  
    }

    #petCanvas{
      width: min(86dvw, 440px) !important;  /* 画面の実測幅に対して拡大 */
      max-height: 56vh !important;
      background: none; border: none; box-shadow: none; border-radius: 0;
      overflow: visible;
    }
    .pet-canvas img{
      width:100%; 
      height:auto; 
      object-fit:contain; 
      display:block; 
      transform-origin:50% 80%; 
    }

    .fx-layer{ position:absolute; inset:0; pointer-events:none; }

    #feedBtn {
      font-size: 19px;
      padding: 14px 24px;
      margin-top: 4px !important;
    }

    /* アニメーション（前回と同じ） */
    @keyframes chubby-bounce { 0%{transform:scale(1)} 20%{transform:scale(1.06,1.03) translateY(-2px)} 40%{transform:scale(1.1,1.06)} 60%{transform:scale(1.08,1.05)} 80%{transform:scale(1.06,1.03)} 100%{transform:scale(1)} }
    @keyframes slim-sway { 0%{transform:scale(1)} 20%{transform:scale(.94,.96) rotate(-1deg)} 40%{transform:scale(.92,.95) rotate(1deg)} 60%{transform:scale(.93,.95) rotate(-.6deg)} 80%{transform:scale(.95,.97) rotate(.6deg)} 100%{transform:scale(1)} }
    @keyframes sparkle-fall { 0%{transform:translateY(-20%) scale(.6);opacity:0} 10%{opacity:1} 100%{transform:translateY(120%) scale(1);opacity:0} }
    .fatting img{ animation: chubby-bounce .9s ease; }
    .slimming img{ animation: slim-sway 1.1s ease; }
    .sparkle{
      position:absolute; top:-10%; width:10px; height:10px; border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff 0 20%, #ffd9c6 22% 60%, transparent 62%);
      filter: drop-shadow(0 0 6px rgba(255,180,150,.6));
      animation: sparkle-fall 1.6s linear forwards;
    }

    .row-center{ display:flex; justify-content:center; }
    .btn,button.btn{
      display:inline-grid; place-items:center; gap:6px; cursor:pointer;
      font-family:"Hachi Maru Pop",cursive; font-size:18px; font-weight:700;
      padding:12px 20px; border-radius:999px; border:1px solid var(--pri-line);
      background:var(--pri); color:var(--ink);
      box-shadow: 0 2px 0 rgba(0,0,0,.05), 0 4px 14px rgba(255,160,120,.15);
    }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .log{ font-size:12px; color:var(--sub); display:grid; gap:6px; max-height:22vh; overflow:auto; }
    .log-item{ background:#fff; border:1px dashed var(--line); border-radius:8px; padding:6px 8px; }

    /* タブバー：画面最下部に固定（さらに下へ寄せる） */
    .tabbar{
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 6px;
      background: #fff;
      border-top: 2px solid var(--line2);
      padding: 6px 6px calc(6px + env(safe-area-inset-bottom));
      height: var(--tabbar-h);
      box-sizing: border-box;
    }
    .tabbar .tab{
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: #fff7f1;
      font-family: "Hachi Maru Pop", cursive;
      font-size: 11px;
      color: #444;
      cursor: pointer;
      padding: 8px 4px 6px;
    }
    .tabbar .tab i{
      font-size: 20px;
      line-height: 1;
    }
    .tabbar .tab.active{
      background: #ffe6d7;
      border-color: #ffccb3;
      color: #A3A649;
    }
    .tabbar .tab:focus-visible{ outline:2px solid #ffb999; outline-offset:2px; }

  </style>
</head>
<body data-page="main">
  <div class="phone">
    <div class="screen">
      <div class="island" aria-hidden="true"></div>

      <main id="app" class="fade">
        <section class="hero">
          <div class="app-title">ペットと<br>ごはんの時間</div>
          <div class="lead">「ごはん」ボタンで育てよう！</div>
        </section>

        <section class="main-wrap">
          <article class="card">
            <div class="pet-stage">
              <div class="pet-canvas" id="petCanvas">
                <img id="petImg" src="./assets/img/pets/placeholder.png" alt="ペット">
                <div class="fx-layer" id="fx"></div>
              </div>
              <div id="petMeta" class="pet-name"></div>

              <div class="row-center">
                <button id="feedBtn" class="btn" type="button">🍙 ごはんをあげる</button>
              </div>
            </div>
          </article>

          <article class="card">
            <h3 style="margin:0; font-size:16px;">きろく</h3>
            <div id="log" class="log" aria-live="polite"></div>
          </article>
        </section>
      </main>

      <!-- タブバー -->
    <nav class="tabbar" role="navigation" aria-label="メインナビ">
      <button class="tab" data-tab="mypage" aria-label="マイページ">
        <i class="fa-solid fa-user"></i><span>My Page</span>
      </button>
      <button class="tab" data-tab="accessory" aria-label="着替え">
        <i class="fa-solid fa-shirt"></i><span>着せ替え</span>
      </button>
      <button class="tab active" data-tab="home" aria-current="page" aria-label="ホーム">
        <i class="fa-solid fa-house"></i><span>Home</span>
      </button>
      <button class="tab" data-tab="friends" aria-label="友だち">
        <i class="fa-solid fa-user-group"></i><span>友だち</span>
      </button>
      <button class="tab" data-tab="settings" aria-label="設定">
        <i class="fa-solid fa-gear"></i><span>設定</span>
      </button>
    </nav>
    </div>
  </div>

  <script type="module">
    try {
      const { initChrome } = await import("./assets/common.js");
      if (typeof initChrome === "function") initChrome();
    } catch(e){ console.warn("initChrome読み込み失敗:", e); }

    const $ = (s, r=document)=>r.querySelector(s);

    const KEY_PET      = 'tky.pet';
    const KEY_PET_NAME = 'tky.petName';
    const KEY_NUTRI_TODAY = 'tky.nutri.today';

    const COOLDOWN_MS = 10_000;

    function loadJSON(key, fb=null){ try{ const raw=localStorage.getItem(key); return raw?JSON.parse(raw):fb; }catch{ return fb; } }

    const pet = loadJSON(KEY_PET, null);
    const petName = (localStorage.getItem(KEY_PET_NAME) || '').trim();

    function resolvePetImage(pet){
      if (pet && pet.id) {
        const base = `./assets/img/pets/${pet.id}`;
        const staged = `${base}_stage0_idle.png`;
        return pet.img || staged || './assets/img/pets/placeholder.png';
      }
      return './assets/img/pets/placeholder.png';
    }

    function renderAll(){
      const img = $('#petImg');
      const meta = $('#petMeta');
      img.src = resolvePetImage(pet);
      img.alt = (petName || pet?.label || pet?.id || 'ペット') + ' の表示';
      meta.textContent = petName || (pet?.label || pet?.id || 'ななし');
    }

    function logPush(msg){
      const box = $('#log');
      const item = document.createElement('div');
      item.className = 'log-item';
      const time = new Date().toLocaleTimeString('ja-JP',{hour:'2-digit',minute:'2-digit'});
      item.textContent = `［${time}］ ${msg}`;
      box.prepend(item);
    }

    function evaluateTodayNutrition(){
      const today = new Date().toISOString().slice(0,10);
      const s = loadJSON(KEY_NUTRI_TODAY, null);
      if (!s || s.date !== today){
        const r = Math.random();
        return r < .33 ? 'chubby' : (r < .66 ? 'slim' : 'sparkle');
      }
      const total = s.totalMeals ?? 0;
      const junk  = s.junkCount ?? 0;
      const bal   = s.balancedScore ?? 0;
      if (total <= 1) return 'slim';
      if (total > 0 && junk/total >= 0.5) return 'chubby';
      if (bal >= 0.7) return 'sparkle';
      return 'normal';
    }

    function playAnimation(kind){
      const canvas = $('#petCanvas');
      const fx = $('#fx');
      canvas.classList.remove('fatting','slimming');
      fx.innerHTML = '';

      if (kind === 'chubby'){
        canvas.classList.add('fatting');
        logPush('🍔 きょうはジャンク多め…ぷにっと太った！');
      } else if (kind === 'slim'){
        canvas.classList.add('slimming');
        logPush('🥺 あまり食べられなかったみたい…ほっそり。');
      } else if (kind === 'sparkle'){
        const n = 12 + Math.floor(Math.random()*4);
        for (let i=0;i<n;i++){
          const sp = document.createElement('div');
          sp.className = 'sparkle';
          sp.style.left = Math.random()*100 + '%';
          sp.style.animationDelay = (Math.random()*0.6) + 's';
          sp.style.width = sp.style.height = (8 + Math.random()*10) + 'px';
          fx.appendChild(sp);
          sp.addEventListener('animationend', ()=> sp.remove());
        }
        logPush('✨ バランスよく食べられたね！キラキラ～');
      } else {
        logPush('🍙 もぐもぐ…');
      }
      setTimeout(()=> canvas.classList.remove('fatting','slimming'), 1200);
    }

    // 「待っててね」テキストは廃止。ボタンの無効化だけ行う。
    let lastFedAt = 0;
    function canFeedNow(){ return (Date.now() - lastFedAt) >= COOLDOWN_MS; }
    function setCooldownUI(active){ $('#feedBtn').disabled = active; }

    async function onFeed(){
      if (!canFeedNow()){ setCooldownUI(true); return; }
      lastFedAt = Date.now();
      playAnimation(evaluateTodayNutrition());
      setCooldownUI(true);
      setTimeout(()=> setCooldownUI(false), COOLDOWN_MS);
    }

    renderAll();
    $('#feedBtn')?.addEventListener('click', onFeed);
    setCooldownUI(!canFeedNow());

    // タブ遷移
    const TabToPath = {
      mypage:'./mypage.html', accessory:'./accessory.html', home:'./main.html',
      friends:'./friends.html', settings:'./settings.html'
    };
    (function syncActiveTab(){
      const now = location.pathname.split('/').pop().toLowerCase();
      document.querySelectorAll('.tabbar .tab').forEach(btn=>{
        const key = btn.getAttribute('data-tab');
        const path = TabToPath[key];
        const isActive = path && now === path.split('/').pop().toLowerCase();
        btn.classList.toggle('active', !!isActive);
        btn.setAttribute('aria-current', isActive ? 'page' : 'false');
      });
    })();
    document.querySelector('.tabbar')?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.tab'); if(!btn) return;
      const key = btn.getAttribute('data-tab'); const to = TabToPath[key]; if(!to) return;
      const now = location.pathname.split('/').pop().toLowerCase();
      if (now === to.split('/').pop().toLowerCase()) return;
      location.href = to;
    });
  </script>
</body>
</html>
