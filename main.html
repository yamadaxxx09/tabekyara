<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>たべきゃら | メイン</title>
  <link href="https://fonts.googleapis.com/css2?family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">

  <style>
    :root{
      --top-gap: clamp(16px, 6vh, 56px);
      --overlap: 10px;
      --float-bobY: 12px;
      --float-swayX: 5px;
      --float-tilt: 2deg;
      --float-bobT: 1.8s;
      --float-swayT: 2.2s;
      --tabbar-h: 64px;
    }

    html,body{
      height:100%; margin:0;
      font-family:"Hachi Maru Pop",cursive;
      background:var(--bg);
    }

    .phone,.screen{
      height:100svh; display:flex; flex-direction:column;
      overflow:hidden;
    }

    main{
      flex:1; display:flex; flex-direction:column; align-items:center;
      justify-content:flex-start;
      padding:8px 16px calc(var(--tabbar-h) + env(safe-area-inset-bottom));
      box-sizing:border-box;
      overflow:hidden;
    }

    .hero{ display:grid; place-items:center; text-align:center; gap:6px; padding:16px 16px 4px; margin-top:44px; }
    .app-title{ font-size:clamp(22px,5.2vw,30px); font-weight:900; letter-spacing:.08em; -webkit-text-stroke:1px rgba(0,0,0,.06); line-height:1.05; }
    .lead{ color:var(--sub); font-size:13px; }

    .main-wrap{ display:grid; gap:12px; padding:20px 16px 0; }
    .card{ background:none; border:none; box-shadow:none; border-radius:0; display:grid; gap:10px; margin-top:6px; }

    .pet-stage{ position:relative; display:grid; justify-items:center; text-align:center; overflow:visible; gap:0; }
    .pet-name{ position:absolute; top:8px; font-size:clamp(18px,4.2vw,22px); color:#A3A649; letter-spacing:.03em; z-index:3; }
    .pet-canvas{ position:relative; display:grid; place-items:center; width:fit-content; }

    /* ★ 画像の入れ物に比率を与えて潰れを防止 */
    #petCanvas{
      width:min(82dvw,400px) !important;
      aspect-ratio: 1 / 1;
      margin:0 auto 0 !important;
      background:none; border:none;
      display:grid; place-items:center; position:relative;
    }
    /* 画像は入れ物にフィット */
    .pet-canvas img{
      width:100%; height:100%;
      object-fit:contain; display:block;
      transform-origin:50% 80%;
    }

    .row-overlay{ position:absolute; left:0; right:0; bottom:calc(var(--overlap) * -1); display:flex; justify-content:center; z-index:4; }
    #feedBtn{ font-size:19px; padding:12px 22px; margin:0!important; box-shadow:0 4px 14px rgba(0,0,0,.12); }

    .log{ font-size:12px; color:var(--sub); display:grid; gap:6px; max-height:22vh; overflow:auto; }
    .log-item{ background:#fff; border:1px dashed var(--line); border-radius:8px; padding:6px 8px; }

    .tabbar{
      position:absolute; bottom:0; left:0; width:100%;
      display:grid; grid-template-columns:repeat(5,1fr); gap:6px;
      background:#fff; border-top:2px solid var(--line2);
      padding:6px 6px calc(6px + env(safe-area-inset-bottom));
      height:var(--tabbar-h); box-sizing:border-box; flex-shrink:0;
    }
    .tabbar .tab{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      border:1px solid var(--line); border-radius:14px; background:#fff7f1;
      font-size:11px; color:#444; cursor:pointer; padding:8px 4px 6px;
    }
    .tabbar .tab i{ font-size:20px; line-height:1; }
    .tabbar .tab.active{ background:#ffe6d7; border-color:#ffccb3; color:#A3A649; }

    /* === モーダル（中央カード型） === */
    .screen{ position:relative; overflow:hidden; }
    .modal-backdrop{
      position:absolute; inset:0; display:none;
      align-items:center; justify-content:center;
      background:rgba(0,0,0,.25);
      backdrop-filter:saturate(120%) blur(2px);
      z-index:100; transition:opacity .25s ease; opacity:0;
    }
    .modal-backdrop[aria-hidden="false"]{ display:flex; opacity:1; }
    .modal-dialog{
      background:#fffaf7; border:2px solid var(--line2); border-radius:20px;
      box-shadow:0 8px 30px rgba(0,0,0,.15);
      width:90%; max-width:360px; max-height:80%;
      padding:20px 20px 16px; overflow-y:auto;
      animation: popIn .25s ease-out both; font-family:"Hachi Maru Pop",cursive;
    }
    .modal-dialog h3{ font-size:18px; margin:0 0 6px; color:#444; }
    .modal-lead{ margin:0 0 12px; color:var(--sub); font-size:13px; }
    .modal-form{ display:grid; gap:14px; font-size:15px; }
    .modal-form fieldset{ border:none; margin:0; padding:0; display:grid; gap:6px; }
    .modal-form legend{ font-weight:700; font-size:15px; margin-bottom:4px; color:#553; }
    .modal-form label{ background:#fff7f1; border:1px solid var(--line); border-radius:12px;
      padding:10px 12px; display:flex; align-items:flex-start; gap:10px; transition:background .2s, transform .1s; }
    .modal-form label:hover{ background:#ffe9de; transform:translateY(-1px); }
    .modal-form input[type="radio"]{ transform:scale(1.2); accent-color:#A3A649; }
    .modal-form label div{ display:flex; flex-direction:column; line-height:1.3; }
    .modal-form small{ font-size:12px; color:#777; }
    .modal-actions{ display:flex; justify-content:flex-end; gap:10px; margin-top:12px; padding-top:12px; border-top:1px solid var(--line2); }
    @keyframes popIn{ from{opacity:0; transform:scale(.95);} to{opacity:1; transform:scale(1);} }

    /* ==== ふわゆら（ラッパーに付与） ==== */
    @keyframes bobY { from { transform: translateY(-12px); } to { transform: translateY(12px); } }
    @keyframes swayXR { from { transform: translateX(-5px) rotate(-2deg); } to { transform: translateX(5px) rotate(2deg); } }
    .floaty {
      animation: bobY var(--float-bobT) ease-in-out infinite alternate,
                 swayXR var(--float-swayT) ease-in-out infinite alternate;
      transform-origin: 50% 80%;
      will-change: transform;
      backface-visibility: hidden;
    }
    .floaty-wrap{ position:relative; width:100%; height:100%; }

    @media (prefers-reduced-motion: reduce) { .floaty { animation:none !important; } }
  </style>
</head>

<body data-page="main">
  <div class="phone">
    <div class="screen">
      <main id="app">
        <section class="hero">
          <div class="app-title">ペットと<br>ごはんの時間</div>
          <div class="lead">「ごはん」ボタンで育てよう！</div>
        </section>

        <section class="main-wrap">
          <article class="card">
            <div class="pet-stage">
              <div class="pet-canvas" id="petCanvas">
                <div id="petMeta" class="pet-name"></div>
                <img id="petImg" src="./assets/img/placeholder.png" alt="ペット">
                <div class="row-overlay">
                  <button id="feedBtn" class="btn" type="button">🍙 ごはんをあげる</button>
                </div>
              </div>
            </div>
          </article>

          <article class="card">
            <h3 style="margin:10px 5px; font-size:16px;">きろく</h3>
            <div id="log" class="log" aria-live="polite"></div>
          </article>
        </section>
      </main>

      <!-- ごはんモーダル -->
      <div id="foodModal" class="modal-backdrop" aria-hidden="true">
        <div role="dialog" aria-modal="true" aria-labelledby="foodTitle" class="modal-dialog">
          <h3 id="foodTitle">ごはんをえらぶ</h3>
          <p class="modal-lead">今日のごはんのバランスを教えてね</p>
          <form id="foodForm" class="modal-form">
            <fieldset>
              <legend>主菜（タンパク質）</legend>
              <label><input type="radio" name="protein" value="low" required><div><div>すくなめ</div><small>（豆腐・卵少しなど軽め）</small></div></label>
              <label><input type="radio" name="protein" value="mid"><div><div>ふつう</div><small>（鶏や魚などをしっかり一品）</small></div></label>
              <label><input type="radio" name="protein" value="high"><div><div>おおめ</div><small>（牛・豚・揚げ物たっぷり）</small></div></label>
            </fieldset>
            <fieldset>
              <legend>野菜・果物</legend>
              <label><input type="radio" name="veggie" value="low" required><div><div>すくなめ</div><small>（野菜なし・少し）</small></div></label>
              <label><input type="radio" name="veggie" value="mid"><div><div>ふつう</div><small>（サラダや副菜1〜2品）</small></div></label>
              <label><input type="radio" name="veggie" value="high"><div><div>たっぷり</div><small>（野菜中心・果物も◎）</small></div></label>
            </fieldset>
            <fieldset>
              <legend>主食（ごはん・パン等）</legend>
              <label><input type="radio" name="carb" value="low" required><div><div>すくなめ</div><small>（少なめ・半分量）</small></div></label>
              <label><input type="radio" name="carb" value="mid"><div><div>ふつう</div><small>（お茶碗1杯・パン1枚ほど）</small></div></label>
              <label><input type="radio" name="carb" value="high"><div><div>おおめ</div><small>（おかわり・麺＋ご飯など）</small></div></label>
            </fieldset>
            <div class="modal-actions">
              <button type="button" id="foodCancel" class="btn" style="background:#fff7f1; border:1px solid var(--line);">やめる</button>
              <button type="submit" class="btn" id="foodOK">OK</button>
            </div>
          </form>
        </div>
      </div>

      <nav class="tabbar">
        <button class="tab" onclick="location.href='mypage.html'"><i class="fa-solid fa-user"></i><span>My Page</span></button>
        <button class="tab" onclick="location.href='accessory.html'"><i class="fa-solid fa-shirt"></i><span>着せ替え</span></button>
        <button class="tab active" onclick="location.href='main.html'"><i class="fa-solid fa-house"></i><span>Home</span></button>
        <button class="tab" onclick="location.href='friends.html'"><i class="fa-solid fa-user-group"></i><span>友だち</span></button>
        <button class="tab" onclick="location.href='settings.html'"><i class="fa-solid fa-gear"></i><span>設定</span></button>
      </nav>
    </div>
  </div>

  <script type="module">
mypage
  const KEY_PET='tky.pet', KEY_PET_NAME='tky.petName';
  const $=(s,r=document)=>r.querySelector(s);
  function loadJSON(k,f=null){try{const r=localStorage.getItem(k);return r?JSON.parse(r):f;}catch{return f}}

  const pet=loadJSON(KEY_PET,null);
  const petName=localStorage.getItem(KEY_PET_NAME)||'';
  const PLACEHOLDER="./assets/img/pets/placeholder.png";

  function candidatesFrom(src){
    const set=new Set();
    if(src) set.add(src);
    const a=src?.replace("/assets/pets/","/assets/img/pets/");
    const b=a?.replace(/^\.?\/img\//,"./assets/img/");
    if(b) set.add(b);
    if(b?.startsWith("/")) set.add("."+b);
    if(b?.startsWith("./")) set.add(b.slice(1));
    const file=(src||"").split("/").pop();
    if(file && !file.includes(".")) set.add(`./assets/img/pets/${file}.png`);
    else if(file) set.add(`./assets/img/pets/${file}`);
    if(b) set.add(b.replace(/^\.\//,"/"));
    set.add(PLACEHOLDER);
    return Array.from(set);
  }
  function resolveAndLoad(src,imgEl){
    const tries=candidatesFrom(src); let i=0;
    (function next(){
      if(i>=tries.length){ imgEl.src=PLACEHOLDER; return; }
      const s=tries[i++], probe=new Image();
      probe.onload=()=>{ imgEl.src=s; };
      probe.onerror=()=>next();
      probe.src=s+(s.includes("?")?"&":"?")+"v="+Date.now();
    })();
  }

  (function render(){
  const imgEl=$('#petImg');
  const nameEl=$('#petMeta');
  if(!imgEl) return;

  // すでに見た目が決まっているなら初期表示はスキップ（後でapplyAppearanceが上書きする）
  const apRaw = localStorage.getItem('tky.appearance');
  if (apRaw) {
    const typeLabel=pet?.label||pet?.id||'ペット';
    if(nameEl) nameEl.textContent = petName ? `${petName}（${typeLabel}）` : `${typeLabel}`;
    return;
  }

  if(!pet){ imgEl.src=PLACEHOLDER; if(nameEl) nameEl.textContent=''; return; }
  const typeLabel=pet.label||pet.id||'ペット';
  if(nameEl) nameEl.textContent = petName ? `${petName}（${typeLabel}）` : `${typeLabel}`;
  imgEl.alt=`${typeLabel} のプレビュー`;
  resolveAndLoad(pet.img||PLACEHOLDER,imgEl);
})();


  // ===== モーダル制御 =====
  const modal = $('#foodModal');
  const feedBtn = $('#feedBtn');
  const foodForm = $('#foodForm');
  const foodCancel = $('#foodCancel');
  const petImg = $('#petImg');
  const petAnim = $('#petAnim');
  const logEl = $('#log');

  function openModal(){
    modal.style.display = 'flex';
    modal.setAttribute('aria-hidden','false');
  }
  function closeModal(){
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }

  feedBtn?.addEventListener('click', openModal);
  foodCancel?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

  // ===== もぐもぐ再生だけやる（1回表示→静止画へ戻す） =====
// ファイル場所： assets/gif/mogumogu.gif
const CHEW_SRC = { gif: './assets/gif/mogumogu.gif' };
let chewing = false;

async function playChewOnce() {
  if (chewing) return;
  chewing = true;

  // もぐもぐGIFを画像として差し替える
  const originalSrc = petImg.src; // 元の画像を保存
  petImg.src = CHEW_SRC.gif;

  // GIFの再生時間分だけ待つ（2〜3秒を目安に調整）
  await new Promise(r => setTimeout(r, 3000));

  // 終了後、元の画像に戻す
  petImg.src = originalSrc;
  chewing = false;
}

  // ===== 送信でログ追加 → もぐもぐ再生 =====
  foodForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const fd = new FormData(foodForm);
    const data = {
      protein: fd.get('protein'),
      veggie:  fd.get('veggie'),
      carb:    fd.get('carb'),
    };
    closeModal();

    addLogRow(data, 'chew'); // いまは「もぐもぐ」固定

    await playChewOnce();
  });

  function addLogRow(data, kind){
    const now = new Date();
    const jst = now.toLocaleString('ja-JP', { hour12:false });
    const mapJP = { low:'すくなめ', mid:'ふつう', high:'おおめ' };
    const label = '🍙 もぐもぐ';
    const div = document.createElement('div');
    div.className = 'log-item';
    div.innerHTML =
      `<strong>${label}</strong> <span style="color:#888;">${jst}</span><br>
       主菜: ${mapJP[data.protein]} / 野菜: ${mapJP[data.veggie]} / 主食: ${mapJP[data.carb]}`;
    logEl?.prepend(div);
  }
  /* ========= ここから “日次判定 + 見た目維持” の追加コード ========= */

// --- 設定（しきい値・連続日数・演出時間ms） ---
const ENERGY_SCORE = { low: 1, mid: 2, high: 3 }; // 量スコア（主菜/主食に効く）
const VEGGIE_BONUS = { low: 0, mid: 1, high: 2 }; // 野菜ボーナス
const FAT_THRESHOLD   = 8;  // これ以上で「多い」→ fat
const THIN_THRESHOLD  = 3;  // これ未満で「少ない」
const THIN_STREAK_N   = 2;  // 少ない日が連続N日でthin
const SPARKLE_RULE = (p, v, c) => (
  // バランス判定例：全部mid か、野菜high かつ 他がmid以下
  (p==='mid' && v==='mid' && c==='mid') ||
  (v==='high' && (p!=='high' && c!=='high'))
);

const TRANSITION_GIF_MS = 2200; // to_fat / to_thin のGIF長さ（mp4なら ended でOK）

// --- ストレージキー ---
const KEY_MEAL_LOG   = 'tky.mealLog';     // { 'YYYY-MM-DD': [ {protein, veggie, carb, ts}, ... ] }
const KEY_APPEARANCE = 'tky.appearance';  // { petId, state, since:'YYYY-MM-DD', lastEval:'YYYY-MM-DD' }
//const KEY_PET        = 'tky.pet';

// --- ユーティリティ（日付はローカル基準でOK） ---
const fmtDate = (d=new Date()) => d.toISOString().slice(0,10);
const yesterdayStr = () => {
  const d = new Date(); d.setDate(d.getDate()-1);
  return fmtDate(d);
};

// --- ログ保存（既存logUIに加えて日次集計のために保存） ---
function saveMealForToday(entry){ // entry: {protein, veggie, carb}
  const raw = localStorage.getItem(KEY_MEAL_LOG);
  const log = raw ? JSON.parse(raw) : {};
  const today = fmtDate();
  if(!log[today]) log[today] = [];
  log[today].push({...entry, ts: Date.now()});
  localStorage.setItem(KEY_MEAL_LOG, JSON.stringify(log));
}

// 既存の foodForm submit の中で、ログ追加の直後に呼ぶとよい：
// saveMealForToday(data);

// --- 前日を集計して外見を決める ---
function evaluateDay(dayStr){ // return {state:'normal|fat|thin|sparkle', energy, info }
  const raw = localStorage.getItem(KEY_MEAL_LOG);
  const log = raw ? JSON.parse(raw) : {};
  const items = log[dayStr] || [];
  if(items.length===0) return { state:'normal', energy:0, info:{ reason:'no_meal' } };

  // 1日の合計スコア
  let energy = 0;
  let balanced = false;
  for(const it of items){
    energy += (ENERGY_SCORE[it.protein]||0) + (ENERGY_SCORE[it.carb]||0) + (VEGGIE_BONUS[it.veggie]||0);
    if (SPARKLE_RULE(it.protein, it.veggie, it.carb)) balanced = true;
  }

  // 仮のルール：balancedなら sparkle を最優先
  if (balanced) return { state:'sparkle', energy, info:{ reason:'balanced' } };
  if (energy >= FAT_THRESHOLD) return { state:'fat', energy, info:{ reason:'high_energy' } };

  // thin は “少ない日” が連続 N 日
  const isThinDay = energy < THIN_THRESHOLD;
  if (isThinDay) {
    const streak = countThinStreakEndingAt(dayStr);
    if (streak >= THIN_STREAK_N) return { state:'thin', energy, info:{ reason:'thin_streak', streak } };
  }

  return { state:'normal', energy, info:{ reason:'default' } };
}

function countThinStreakEndingAt(dayStr){
  const raw = localStorage.getItem(KEY_MEAL_LOG);
  const log = raw ? JSON.parse(raw) : {};
  let streak = 0;
  let d = new Date(dayStr);
  // 後ろ向きに “少ない日” を数える
  for(;;){
    const key = fmtDate(d);
    const items = log[key] || [];
    let energy = 0;
    for(const it of items){
      energy += (ENERGY_SCORE[it.protein]||0) + (ENERGY_SCORE[it.carb]||0) + (VEGGIE_BONUS[it.veggie]||0);
=======
    const K = { PET:'tky.pet', PET_NAME:'tky.petName', MEAL_LOG:'tky.mealLog', APPEARANCE:'tky.appearance' };
    const $ = (s,r=document)=>r.querySelector(s);
    function loadJSON(k,f=null){ try{const r=localStorage.getItem(k); return r?JSON.parse(r):f;}catch{return f;} }

    const pet = loadJSON(K.PET,null);
    const petName = localStorage.getItem(K.PET_NAME)||'';
    const PLACEHOLDER = './assets/img/placeholder.png';
    const petImg = $('#petImg');

    /* ========= 安全ローダー：404ならplaceholderへ ========= */
    function setPetSrcSafe(imgEl, src, placeholder = './assets/img/placeholder.png') {
      if (!imgEl) return;
      const test = new Image();
      test.onload  = () => { imgEl.src = src; };
      test.onerror = () => { imgEl.src = placeholder; };
      test.src = src;
    }

    /* ========= スプライト定義 ========= */
    function staticSpriteFor(state){
      switch(state){
        case 'fat':return'./assets/img/fat.jpg';
        case 'thin':return'./assets/img/thin.jpg';
        case 'sparkle':return'./assets/img/kirakira.jpg';
        default:return(pet?.img||PLACEHOLDER);
      }
main
    }
    function transitionAnimFor(state){
      if(state==='fat')return{gif:'./assets/gif/fat.gif',ms:2200};
      if(state==='thin')return{gif:'./assets/gif/thin.gif',ms:2200};
      if(state==='sparkle')return{gif:'./assets/gif/kirakira.gif',ms:2200};
      return null;
    }

    /* ========= 見た目の保存 ========= */
    function fmtDate(d=new Date()){return d.toISOString().slice(0,10);}
    function getAppearance(){return loadJSON(K.APPEARANCE,null);}
    function setAppearance(o){localStorage.setItem(K.APPEARANCE,JSON.stringify(o));}

    /* ========= その食事だけで即判定 ========= */
    function computeStateFromEntry(entry){
      const ENERGY_SCORE={low:1,mid:2,high:3};
      const VEGGIE_BONUS={low:0,mid:1,high:2};
      const FAT_THRESHOLD=8;   // これ以上なら「太る」
      const THIN_THRESHOLD=3;  // これ未満なら「痩せる」
      const SPARKLE_RULE=(p,v,c)=> (p==='mid'&&v==='mid'&&c==='mid')||(v==='high'&&(p!=='high'&&c!=='high'));

      const energy = (ENERGY_SCORE[entry.protein]||0)
                   + (ENERGY_SCORE[entry.carb]||0)
                   + (VEGGIE_BONUS[entry.veggie]||0);

      const balanced = SPARKLE_RULE(entry.protein, entry.veggie, entry.carb);

      // 優先順位：きらきら > 太る > 痩せる > 通常
      if (balanced) return 'sparkle';
      if (energy >= FAT_THRESHOLD) return 'fat';
      if (energy < THIN_THRESHOLD) return 'thin';
      return 'normal';
    }

    /* ========= 外観反映（即時アニメ対応） ========= */
    let isTransitioning = false;

    async function applyAppearance(state, { playTransitionIfAny = false } = {}) {
      const target = staticSpriteFor(state) + '?t=' + Date.now();

      if (playTransitionIfAny && (state === 'fat' || state === 'thin' || state === 'sparkle')) {
        const trans = transitionAnimFor(state);
        if (trans?.gif) {
          try {
            isTransitioning = true;
            setPetSrcSafe(petImg, trans.gif + '?t=' + Date.now());
            await new Promise(r => setTimeout(r, trans.ms));
          } finally {
            isTransitioning = false;
          }
        }
      }
      setPetSrcSafe(petImg, target);
    }

    /* ========= もぐもぐ（ホールドなし） ========= */
    const CHEW_SRC={gif:'./assets/gif/mogumogu.gif',jpg:'./assets/img/mogumogu.jpg'};
    const CHEW_GIF_MS=2000;
    let chewTimer=null;

    function playChewOnce(){
      if (chewTimer) { clearTimeout(chewTimer); chewTimer=null; }
      setPetSrcSafe(petImg, CHEW_SRC.gif + '?t=' + Date.now());
      return new Promise(resolve=>{
        chewTimer = setTimeout(()=>{
          setPetSrcSafe(petImg, CHEW_SRC.jpg + '?t=' + Date.now());
          resolve();
        }, CHEW_GIF_MS);
      });
    }

    /* ========= 食事入力処理 ========= */
    const modal=$('#foodModal');
    const foodForm=$('#foodForm');
    const foodCancel=$('#foodCancel');
    const feedBtn=$('#feedBtn');
    const logEl=$('#log');

    function openModal(){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
    function closeModal(){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
    feedBtn.addEventListener('click',openModal);
    foodCancel.addEventListener('click',closeModal);
    modal.addEventListener('click',e=>{ if(e.target===modal)closeModal(); });

    function saveMealForToday(entry){
      const raw=localStorage.getItem(K.MEAL_LOG);
      const log=raw?JSON.parse(raw):{};
      const today=fmtDate();
      if(!log[today])log[today]=[];
      log[today].push({...entry,ts:Date.now()});
      localStorage.setItem(K.MEAL_LOG,JSON.stringify(log));
    }

    function addLogRow(data){
      const now=new Date();
      const jst=now.toLocaleString('ja-JP',{hour12:false});
      const mapJP={low:'すくなめ',mid:'ふつう',high:'おおめ'};
      const div=document.createElement('div');
      div.className='log-item';
      div.innerHTML=`<strong>🍙 もぐもぐ</strong> <span style="color:#888;">${jst}</span><br>
        主菜:${mapJP[data.protein]} / 野菜:${mapJP[data.veggie]} / 主食:${mapJP[data.carb]}`;
      logEl.prepend(div);
    }

    foodForm.addEventListener('submit', async e=>{
      e.preventDefault();
      const fd=new FormData(foodForm);
      const entry={protein:fd.get('protein'),veggie:fd.get('veggie'),carb:fd.get('carb')};

      closeModal();
      addLogRow(entry);
      saveMealForToday(entry);

      // 1) もぐもぐ
      await playChewOnce();

      // 2) 即判定 → アニメ → 静止
      const state = computeStateFromEntry(entry);
      await applyAppearance(state, { playTransitionIfAny: true });

      // 3) 最終見た目を保存（任意）
      setAppearance({
        petId:(pet?.id||'pet'),
        state,
        since: fmtDate(),
        lastEval: fmtDate()
      });

      // ラジオ選択をリセット（任意）
      foodForm.reset();
    });

    /* ========= 初期描画 ========= */
    (function(){
      const nameEl=$('#petMeta');
      if(nameEl) nameEl.textContent = petName ? `${petName}（${pet?.label||'ペット'}）` : (pet?.label||'ペット');

      // ふわゆら用ラッパー
      const canvas = document.getElementById('petCanvas');
      if (canvas && petImg && !petImg.parentElement.classList.contains('floaty-wrap')) {
        const wrap = document.createElement('div');
        wrap.className = 'floaty-wrap floaty';
        canvas.insertBefore(wrap, petImg);
        wrap.appendChild(petImg);
      }

      // 初期画像：保存された見た目があればそれ、なければ通常
      const ap=getAppearance();
      const initState = ap?.state || 'normal';
      setPetSrcSafe(petImg, staticSpriteFor(initState));
    })();
  </script>
</body>
</html>
