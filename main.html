<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ãŸã¹ãã‚ƒã‚‰ | ãƒ¡ã‚¤ãƒ³</title>
  <link href="https://fonts.googleapis.com/css2?family=Hachi+Maru+Pop&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./assets/styles.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6/css/all.min.css">
  <style>
    :root{ --top-gap: clamp(16px, 6vh, 56px); --overlap: 10px; }

    html,body{
      height:100%; margin:0;
      font-family:"Hachi Maru Pop",cursive;
      background:var(--bg);
    }

    /* 1ç”»é¢å›ºå®šãƒ»ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãªã— */
    .phone,.screen{
      height:100svh; display:flex; flex-direction:column;
      overflow:hidden;
    }

    main{
      flex:1; display:flex; flex-direction:column; align-items:center;
      justify-content:flex-start;
      padding:8px 16px calc(var(--tabbar-h) + env(safe-area-inset-bottom));
      box-sizing:border-box;
      overflow:hidden;
    }

    .hero{ display:grid; place-items:center; text-align:center; gap:6px; padding:16px 16px 4px; margin-top:44px; }
    .app-title{
      font-size:clamp(22px,5.2vw,30px); font-weight:900; letter-spacing:.08em;
      -webkit-text-stroke:1px rgba(0,0,0,.06); line-height:1.05;
    }
    .lead{ color:var(--sub); font-size:13px; }

    .main-wrap{ display:grid; gap:12px; padding:20px 16px 0; }

    .card{ background:none; border:none; box-shadow:none; border-radius:0; display:grid; gap:10px; margin-top:6px; }

    /* ===== ãƒšãƒƒãƒˆï¼†ãƒœã‚¿ãƒ³é‡ã­ ===== */
    .pet-stage{
      position:relative;
      display:grid;
      justify-items:center;
      text-align:center;
      overflow:visible; /* ã¯ã¿å‡ºã—ã‚’è¦‹ã›ã‚‹ */
      gap:0;           /* ä½™ç™½ã‚¼ãƒ­ */
    }

    .pet-name{
      position:absolute; top:8px; font-size:clamp(18px,4.2vw,22px);
      color:#A3A649; letter-spacing:.03em; z-index:3;
    }

    .pet-canvas{
      position:relative;         /* â† ãƒœã‚¿ãƒ³ã®åŸºæº–ã«ã™ã‚‹ */
      display:grid; place-items:center;
      width:fit-content;
    }

    #petCanvas{
      width:min(82dvw,400px) !important;
      max-height:54vh !important;
      margin:0 auto 0 !important; /* ä¸‹ä½™ç™½ã‚¼ãƒ­ï¼ˆé‡ã­ã‚‹ã®ã§ä¸è¦ï¼‰ */
      background:none; border:none; box-shadow:none; border-radius:0;
      display:grid; place-items:center; position:relative;
    }

    .pet-canvas img{
      width:100%; height:auto; object-fit:contain; display:block; transform-origin:50% 80%;
    }

    .fx-layer{ position:absolute; inset:0; pointer-events:none; z-index:2; }


    /* ã“ã“ãŒé‡ã­ã‚‹è‚ï¼šç”»åƒã®ä¸­ã«çµ¶å¯¾é…ç½® */
    .row-overlay{
      position:absolute;
      left:0; right:0;
      bottom:calc(var(--overlap) * -1); /* ä¸‹ç«¯ã‹ã‚‰é£Ÿã„ä¸‹ãŒã‚‹é‡ï¼ˆé‡ãªã‚Šï¼‰ */
      display:flex; justify-content:center;
      z-index:4; /* ç”»åƒã‚ˆã‚Šä¸Š */
      pointer-events:auto;
    }

    #feedBtn{
      font-size:19px; padding:12px 22px; margin:0 !important;
      box-shadow:0 4px 14px rgba(0,0,0,.12);
    }

    .log{ font-size:12px; color:var(--sub); display:grid; gap:6px; max-height:22vh; overflow:auto; }
    .log-item{ background:#fff; border:1px dashed var(--line); border-radius:8px; padding:6px 8px; }

    /* ã‚¿ãƒ–ãƒãƒ¼ */
    .tabbar{
      position:absolute; bottom:0; left:0; width:100%;
      display:grid; grid-template-columns:repeat(5,1fr); gap:6px;
      background:#fff; border-top:2px solid var(--line2);
      padding:6px 6px calc(6px + env(safe-area-inset-bottom));
      height:var(--tabbar-h); box-sizing:border-box;
      flex-shrink:0;
    }
    .tabbar .tab{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:4px;
      border:1px solid var(--line); border-radius:14px; background:#fff7f1;
      font-size:11px; color:#444; cursor:pointer; padding:8px 4px 6px;
    }
    .tabbar .tab i{ font-size:20px; line-height:1; }
    .tabbar .tab.active{ background:#ffe6d7; border-color:#ffccb3; color:#A3A649; }
    .tabbar .tab:focus-visible{ outline:2px solid #ffb999; outline-offset:2px; }
  </style>
</head>
<body data-page="main">
  <div class="phone">
    <div class="screen">
      <div class="island" aria-hidden="true"></div>
      <!-- ã”ã¯ã‚“é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
      <div id="foodModal" aria-hidden="true"
          style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.25); z-index:9999;">
        <div role="dialog" aria-modal="true" aria-labelledby="foodTitle"
            style="background:#fff; border:2px solid var(--line2); border-radius:16px; width:min(92vw,520px); max-width:520px; padding:16px; box-shadow:0 14px 40px rgba(0,0,0,.18);">
          <h3 id="foodTitle" style="margin:0 0 8px; font-size:18px;">ã”ã¯ã‚“ã‚’ãˆã‚‰ã¶</h3>

          <p style="margin:0 0 8px; color:var(--sub); font-size:13px;">ä»Šæ—¥ã®ã”ã¯ã‚“ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ•™ãˆã¦ã­</p>

          <form id="foodForm" style="display:grid; gap:10px; font-size:14px;">
            <fieldset style="border:none; padding:0; margin:0;">
              <legend style="font-weight:700; margin-bottom:6px;">ä¸»èœï¼ˆã‚¿ãƒ³ãƒ‘ã‚¯è³ªï¼‰</legend>
              <label><input type="radio" name="protein" value="low"  required> ã™ããªã‚ï¼ˆè±†è…ãƒ»åµå°‘ã—ï¼‰</label>
              <label><input type="radio" name="protein" value="mid"> ãµã¤ã†ï¼ˆé¶ãƒ»é­šãªã©é©é‡ï¼‰</label>
              <label><input type="radio" name="protein" value="high"> ãŠãŠã‚ï¼ˆç‰›ãƒ»è±šãƒ»æšã’ç‰©ãŸã£ã·ã‚Šï¼‰</label>
            </fieldset>

            <fieldset style="border:none; padding:0; margin:0;">
              <legend style="font-weight:700; margin-bottom:6px;">é‡èœãƒ»æœç‰©</legend>
              <label><input type="radio" name="veggie" value="low"  required> ã™ããªã‚</label>
              <label><input type="radio" name="veggie" value="mid"> ãµã¤ã†</label>
              <label><input type="radio" name="veggie" value="high"> ãŸã£ã·ã‚Š</label>
            </fieldset>

            <fieldset style="border:none; padding:0; margin:0;">
              <legend style="font-weight:700; margin-bottom:6px;">ä¸»é£Ÿï¼ˆã”ã¯ã‚“ãƒ»ãƒ‘ãƒ³ç­‰ï¼‰</legend>
              <label><input type="radio" name="carb" value="low"  required> ã™ããªã‚</label>
              <label><input type="radio" name="carb" value="mid"> ãµã¤ã†</label>
              <label><input type="radio" name="carb" value="high"> ãŠãŠã‚</label>
            </fieldset>

            <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
              <button type="button" id="foodCancel" class="btn" style="background:#fff7f1; border:1px solid var(--line);">ã‚„ã‚ã‚‹</button>
              <button type="submit" class="btn" id="foodOK">OK</button>
            </div>
          </form>
        </div>
      </div>

      <main id="app" class="fade">
        <section class="hero">
          <div class="app-title">ãƒšãƒƒãƒˆã¨<br>ã”ã¯ã‚“ã®æ™‚é–“</div>
          <div class="lead">ã€Œã”ã¯ã‚“ã€ãƒœã‚¿ãƒ³ã§è‚²ã¦ã‚ˆã†ï¼</div>
        </section>

        <section class="main-wrap">
          <article class="card">
            <div class="pet-stage">
              <div class="pet-canvas" id="petCanvas">
                <div id="petMeta" class="pet-name"></div>
                <img id="petImg" src="./assets/img/pets/placeholder.png" alt="ãƒšãƒƒãƒˆ" decoding="async" loading="lazy">
                <div class="fx-layer" id="fx"></div>
                <!-- ç”»åƒã®ä¸Šã«å‹•ç”»ï¼ˆå†ç”Ÿæ™‚ã ã‘è¡¨ç¤ºï¼‰ -->
                <video id="petAnim"
                       playsinline
                       muted
                       preload="auto"
                       poster="./assets/img/pets/placeholder.png"
                       style="position:absolute; inset:0; width:100%; height:100%; object-fit:contain; display:none; z-index:2;">
                  <!-- WebMå„ªå…ˆï¼‹MP4ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ã‚Œã°ï¼‰ -->
                  <!-- ã‚½ãƒ¼ã‚¹ã¯JSã§åˆ‡ã‚Šæ›¿ãˆã‚‹ã®ã§æœ€åˆã¯ç©ºã§OK -->
                </video>

              
                <div class="row-overlay">
                  <button id="feedBtn" class="btn" type="button">ğŸ™ ã”ã¯ã‚“ã‚’ã‚ã’ã‚‹</button>
                </div>
              </div>
            </div>
          </article>

          <article class="card">
            <h3 style="margin:0; font-size:16px;">ãã‚ã</h3>
            <div id="log" class="log" aria-live="polite"></div>
          </article>
        </section>
      </main>

      <nav class="tabbar" role="navigation" aria-label="ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“">
        <button class="tab" data-tab="mypage" aria-label="ãƒã‚¤ãƒšãƒ¼ã‚¸">
          <i class="fa-solid fa-user"></i><span>My Page</span>
        </button>
        <button class="tab" data-tab="accessory" aria-label="ç€æ›¿ãˆ">
          <i class="fa-solid fa-shirt"></i><span>ç€ã›æ›¿ãˆ</span>
        </button>
        <button class="tab active" data-tab="home" aria-current="page" aria-label="ãƒ›ãƒ¼ãƒ ">
          <i class="fa-solid fa-house"></i><span>Home</span>
        </button>
        <button class="tab" data-tab="friends" aria-label="å‹ã ã¡">
          <i class="fa-solid fa-user-group"></i><span>å‹ã ã¡</span>
        </button>
        <button class="tab" data-tab="settings" aria-label="è¨­å®š">
          <i class="fa-solid fa-gear"></i><span>è¨­å®š</span>
        </button>
      </nav>
    </div>
  </div>

  <script type="module">
    const KEY_PET='tky.pet', KEY_PET_NAME='tky.petName';
    const $=(s,r=document)=>r.querySelector(s);
    function loadJSON(k,f=null){try{const r=localStorage.getItem(k);return r?JSON.parse(r):f;}catch{return f}}

    const pet=loadJSON(KEY_PET,null);
    const petName=localStorage.getItem(KEY_PET_NAME)||'';
    const PLACEHOLDER="./assets/img/pets/placeholder.png";

    function candidatesFrom(src){
      const set=new Set();
      if(src) set.add(src);
      const a=src?.replace("/assets/pets/","/assets/img/pets/");
      const b=a?.replace(/^\.?\/img\//,"./assets/img/");
      if(b) set.add(b);
      if(b?.startsWith("/")) set.add("."+b);
      if(b?.startsWith("./")) set.add(b.slice(1));
      const file=(src||"").split("/").pop();
      if(file && !file.includes(".")) set.add(`./assets/img/pets/${file}.png`);
      else if(file) set.add(`./assets/img/pets/${file}`);
      if(b) set.add(b.replace(/^\.\//,"/"));
      set.add(PLACEHOLDER);
      return Array.from(set);
    }
    function resolveAndLoad(src,imgEl){
      const tries=candidatesFrom(src); let i=0;
      (function next(){
        if(i>=tries.length){ imgEl.src=PLACEHOLDER; return; }
        const s=tries[i++], probe=new Image();
        probe.onload=()=>{ imgEl.src=s; };
        probe.onerror=()=>next();
        probe.src=s+(s.includes("?")?"&":"?")+"v="+Date.now();
      })();
    }

    (function render(){
      const imgEl=$('#petImg');
      const nameEl=$('#petMeta');
      if(!imgEl) return;
      if(!pet){ imgEl.src=PLACEHOLDER; if(nameEl) nameEl.textContent=''; return; }
      const typeLabel=pet.label||pet.id||'ãƒšãƒƒãƒˆ';
      if(nameEl) nameEl.textContent = petName ? `${petName}ï¼ˆ${typeLabel}ï¼‰` : `${typeLabel}`;
      imgEl.alt=`${typeLabel} ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼`;
      resolveAndLoad(pet.img||PLACEHOLDER,imgEl);
    })();

    // ===== ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ =====
const modal = $('#foodModal');
const feedBtn = $('#feedBtn');
const foodForm = $('#foodForm');
const foodCancel = $('#foodCancel');
const petImg = $('#petImg');
const petAnim = $('#petAnim');
const logEl = $('#log');

function openModal(){
  modal.style.display = 'flex';
  modal.setAttribute('aria-hidden','false');
}
function closeModal(){
  modal.style.display = 'none';
  modal.setAttribute('aria-hidden','true');
}

feedBtn?.addEventListener('click', openModal);
foodCancel?.addEventListener('click', closeModal);
modal?.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); });

// ===== ã‚¢ãƒ‹ãƒ¡åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ =====
// ã–ã£ãã‚Šï¼šã‚¿ãƒ³ãƒ‘ã‚¯è³ªhigh + ç‚­æ°´åŒ–ç‰©high â†’ å¢—é‡ã€é‡èœhighã‹ã¤ä»–ãŒlowå¯„ã‚Š â†’ æ¸›é‡ã€ãã‚Œä»¥å¤– â†’ ãµã¤ã†
function decideAnimation({protein, veggie, carb}){
  const heavy = (protein === 'high' && carb === 'high') || (protein === 'high' && veggie === 'low');
  const light = (veggie === 'high' && protein !== 'high' && carb !== 'high') || (protein === 'low' && carb === 'low');
  if (heavy) return 'gain';   // å¤ªã‚‹
  if (light) return 'lose';   // ç—©ã›ã‚‹
  return 'idle';              // ãµã¤ã†
}

// ã‚¢ãƒ‹ãƒ¡ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ï¼ˆè‡ªåˆ†ã®å®Ÿãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã¦ã­ï¼‰
const ANIM_SRC = {
  gain: { webm: './assets/video/pet_gain.webm', mp4: './assets/video/pet_gain.mp4' },
  lose: { webm: './assets/video/pet_lose.webm', mp4: './assets/video/pet_lose.mp4' },
  idle: { webm: './assets/video/pet_idle.webm', mp4: './assets/video/pet_idle.mp4' },
};

// å†ç”Ÿãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼šå‹•ç”»â†’çµ‚ã‚ã£ãŸã‚‰é™æ­¢ç”»ã¸æˆ»ã™ï¼ˆã‚‚ã—ãã¯idleãƒ«ãƒ¼ãƒ—ã«æˆ»ã™ï¼‰
let isAnimating = false;
async function playAnim(kind='idle'){
  if (!petAnim) return;
  if (isAnimating) return;
  isAnimating = true;

  // ç”»åƒã¯ä¸€æ—¦éš ã™
  petImg.style.visibility = 'hidden';

  // ã‚½ãƒ¼ã‚¹å·®ã—æ›¿ãˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶äº’æ›ï¼šWebMâ†’MP4ã®é †ã§è©¦ã™ï¼‰
  petAnim.pause();
  petAnim.innerHTML = ''; // æ—¢å­˜sourceã‚¯ãƒªã‚¢
  const { webm, mp4 } = ANIM_SRC[kind] || ANIM_SRC.idle;
  if (webm) {
    const s1 = document.createElement('source'); s1.src = webm; s1.type = 'video/webm'; petAnim.appendChild(s1);
  }
  if (mp4) {
    const s2 = document.createElement('source'); s2.src = mp4; s2.type = 'video/mp4'; petAnim.appendChild(s2);
  }
  petAnim.loop = (kind === 'idle');     // idleã¯ãƒ«ãƒ¼ãƒ—ã€ãã‚Œä»¥å¤–ã¯1å›å†ç”Ÿ
  petAnim.currentTime = 0;
  petAnim.style.display = 'block';

  try {
    await petAnim.play();
  } catch(e) {
    // è‡ªå‹•å†ç”ŸãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ãƒŸãƒ¥ãƒ¼ãƒˆ&ã‚¯ãƒªãƒƒã‚¯é–‹å§‹ãªã©æ¤œè¨
    console.warn('autoplay blocked?', e);
  }

  // 1å›å†ç”Ÿç³»ã¯çµ‚äº†å¾Œidleã«æˆ»ã™
  if (!petAnim.loop) {
    petAnim.onended = async () => {
      petAnim.onended = null;
      // idleã«æˆ»ã™ï¼ˆidleå‹•ç”»ãŒã‚ã‚Œã°ãƒ«ãƒ¼ãƒ—å†ç”Ÿï¼ãªã‘ã‚Œã°ç”»åƒã‚’æˆ»ã™ï¼‰
      if (ANIM_SRC.idle?.mp4 || ANIM_SRC.idle?.webm) {
        await playIdleLoop();
      } else {
        petAnim.style.display = 'none';
        petImg.style.visibility = 'visible';
        isAnimating = false;
      }
    };
  } else {
    // idleã‚’æµã—ç¶šã‘ã‚‹å ´åˆã¯ã“ã¡ã‚‰ã§è§£é™¤ã—ãªã„
    isAnimating = false;
  }
}

async function playIdleLoop(){
  // idleã«åˆ‡æ›¿
  petAnim.pause();
  petAnim.innerHTML = '';
  const { webm, mp4 } = ANIM_SRC.idle;
  if (webm) {
    const s1 = document.createElement('source'); s1.src = webm; s1.type = 'video/webm'; petAnim.appendChild(s1);
  }
  if (mp4) {
    const s2 = document.createElement('source'); s2.src = mp4; s2.type = 'video/mp4'; petAnim.appendChild(s2);
  }
  petAnim.loop = true;
  petAnim.currentTime = 0;
  petAnim.style.display = 'block';
  try { await petAnim.play(); } catch {}
  // ç”»åƒã¯éš ã—ãŸã¾ã¾ï¼ˆidleå‹•ç”»ãŒå¸¸ã«è¡¨ç¤ºã•ã‚Œã‚‹è¨­è¨ˆï¼‰
  petImg.style.visibility = 'hidden';
  isAnimating = false;
}

// ã¯ã˜ã‚ã«idleãŒã‚ã‚‹ãªã‚‰æµã—ã¦ãŠãï¼ˆãªã‘ã‚Œã°é™æ­¢ç”»ã®ã¾ã¾ï¼‰
if (ANIM_SRC.idle?.mp4 || ANIM_SRC.idle?.webm) {
  playIdleLoop();
}

// ===== é€ä¿¡ã§åˆ¤å®šâ†’å†ç”Ÿï¼‹ãƒ­ã‚°è¿½åŠ  =====
foodForm?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fd = new FormData(foodForm);
  const data = {
    protein: fd.get('protein'),
    veggie:  fd.get('veggie'),
    carb:    fd.get('carb'),
  };
  const kind = decideAnimation(data); // 'gain' | 'lose' | 'idle'
  closeModal();

  // ãƒ­ã‚°
  addLogRow(data, kind);

  // ã‚¢ãƒ‹ãƒ¡å†ç”Ÿ
  await playAnim(kind);
});

function addLogRow(data, kind){
  const now = new Date();
  const jst = now.toLocaleString('ja-JP', { hour12:false });
  const mapJP = { low:'ã™ããªã‚', mid:'ãµã¤ã†', high:'ãŠãŠã‚' };
  const label = (kind==='gain')?'â¤´ å¤ªã£ãŸ':(kind==='lose')?'â¤µ ç—©ã›ãŸ':'ï¼ ãµã¤ã†';
  const div = document.createElement('div');
  div.className = 'log-item';
  div.innerHTML =
    `<strong>${label}</strong> <span style="color:#888;">${jst}</span><br>
     ä¸»èœ: ${mapJP[data.protein]} / é‡èœ: ${mapJP[data.veggie]} / ä¸»é£Ÿ: ${mapJP[data.carb]}`;
  logEl?.prepend(div);
}

  </script>
</body>
</html>
